<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ちいかわ ご当地キーホルダー 所持チェック</title>
  <style>
    :root{--bg:#0f172a;--panel:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#22d3ee;--accent2:#a78bfa;--ok:#34d399}
    body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Noto Sans JP,Meiryo,sans-serif;background:#0b1225;color:var(--text)}
    header{position:sticky;top:0;background:#0f172a;z-index:10;border-bottom:1px solid #1f2937}
    .wrap{max-width:1100px;margin:auto;padding:12px}
    h1{margin:0 0 8px}
    input,select,button,textarea{margin:4px;padding:8px;border-radius:8px;border:1px solid #2b3a5d;background:#0b1327;color:var(--text)}
    button{cursor:pointer;background:linear-gradient(135deg,var(--accent2),var(--accent));border:none}
    .ghost{background:transparent;border:1px solid #2b3a5d}
    .panel{background:#111827;margin:12px 0;padding:10px;border-radius:10px}
    .small{font-size:12px;color:#94a3b8}
    .card{background:#0b1327;padding:8px;margin:6px 0;border-radius:6px;display:flex;align-items:center;gap:8px}
    details.region{margin:12px 0;border:1px solid #2b3a5d;border-radius:8px;overflow:hidden}
    details.region>summary{list-style:none;cursor:pointer;padding:10px 12px;background:#0b1327;font-weight:700;color:var(--accent)}
    details.region>summary::-webkit-details-marker{display:none}
    details.region .inner{padding:8px 12px;background:#0f172a}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .ok{color:#10b981}
    .warn{color:#f59e0b}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:8px}
  </style>
</head>
<body>
<header class="wrap">
  <h1>ちいかわ ご当地キーホルダー 所持チェック</h1>
  <div id="stats" class="small"></div>
  <div class="wrap row">
    <button id="btnPrint">一覧を表示/印刷</button>
    <button id="btnCSVAll">CSV (全件)</button>
    <button id="btnToggleCfg" class="ghost">Firebase設定</button>
    <span class="small" style="opacity:.85">地域→都道府県→名称で出力</span>
  </div>
  <div class="panel wrap" id="cfgPanel" style="display:none">
    <div class="row">
      <input id="cfgApiKey" placeholder="apiKey" class="grow" style="min-width:280px">
      <input id="cfgAuthDomain" placeholder="authDomain (xxx.firebaseapp.com)" class="grow" style="min-width:280px">
      <input id="cfgProjectId" placeholder="projectId" class="grow" style="min-width:220px">
    </div>
    <div class="row">
      <textarea id="cfgJson" placeholder='JSON貼り付け可 {"apiKey":"...","authDomain":"...","projectId":"..."}' style="width:100%;min-height:90px"></textarea>
    </div>
    <div class="row">
      <button id="cfgSave">保存して再読み込み</button>
      <button id="cfgClear" class="ghost">設定を削除</button>
      <span id="cfgStatus" class="small"></span>
    </div>
  </div>
  <div class="wrap row" style="margin-top:6px">
    <input id="familyCode" placeholder="家族コード（例: my-family）" style="min-width:220px">
    <button id="connectBtn" class="ghost">同期オン</button>
    <button id="disconnectBtn" class="ghost">同期オフ</button>
    <span id="syncStatus" class="small">未接続</span>
  </div>
</header>
<main class="wrap" id="app"></main>

<!-- Firebase SDK を ES Modules で読み込み -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js';
import { getFirestore, doc, onSnapshot, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js';

/* --- この中にアプリ全体の処理 --- */
(()=>{
  const LS_KEY='chiikawa-keyholders-v10';
  const CFG_KEY=LS_KEY+'__fb_cfg';
  const FAMILY_KEY=LS_KEY+'__family';
  const REGION_ORDER=["北海道地方","東北地方","関東地方","中部地方","近畿地方","中国地方","四国地方","九州地方","海外","その他"];
  const FULL=[
    {region:"北海道地方",pref:"北海道",name:"北海道"},
    {region:"北海道地方",pref:"北海道",name:"ラベンダー"},
    {region:"北海道地方",pref:"北海道",name:"メロン"},
    {region:"北海道地方",pref:"北海道",name:"マシマガ"},
    {region:"東北地方",pref:"青森県",name:"ねぶた祭"},
    {region:"東北地方",pref:"岩手県",name:"わんこそば"},
    {region:"東北地方",pref:"宮城県",name:"伊達政宗"},
    {region:"東北地方",pref:"秋田県",name:"秋田犬"},
    {region:"東北地方",pref:"山形県",name:"さくらんぼ"},
    {region:"東北地方",pref:"福島県",name:"赤べこ"},
    {region:"関東地方",pref:"東京都",name:"東京タワー"},
    {region:"関東地方",pref:"東京都",name:"雷門"},
    {region:"関東地方",pref:"埼玉県",name:"さつまいも"},
    {region:"関東地方",pref:"千葉県",name:"落花生"},
    {region:"関東地方",pref:"神奈川県",name:"崎陽軒シウマイ"},
    {region:"中部地方",pref:"新潟県",name:"笹団子"},
    {region:"中部地方",pref:"長野県",name:"信州りんご"},
    {region:"中部地方",pref:"静岡県",name:"富士山"},
    {region:"中部地方",pref:"愛知県",name:"ひつまぶし"},
    {region:"近畿地方",pref:"大阪府",name:"たこ焼き"},
    {region:"近畿地方",pref:"兵庫県",name:"神戸牛"},
    {region:"近畿地方",pref:"京都府",name:"八ツ橋"},
    {region:"中国地方",pref:"広島県",name:"広島風お好み焼き"},
    {region:"中国地方",pref:"岡山県",name:"きびだんご"},
    {region:"四国地方",pref:"香川県",name:"讃岐うどん"},
    {region:"四国地方",pref:"愛媛県",name:"みかん"},
    {region:"九州地方",pref:"福岡県",name:"明太子"},
    {region:"九州地方",pref:"長崎県",name:"カステラ"},
    {region:"九州地方",pref:"鹿児島県",name:"黒豚"},
    {region:"九州地方",pref:"沖縄県",name:"シーサー"},
    {region:"海外",pref:"香港",name:"エッグタルト"},
    {region:"海外",pref:"オーストラリア",name:"コアラ"},
    {region:"その他",pref:"JR東日本",name:"E7"},
    {region:"その他",pref:"JR西日本",name:"N700S"},
    {region:"その他",pref:"空港",name:"インパクト"}
  ];

  function today(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
  function normalize(x){return{region:String(x.region||''),pref:String(x.pref||''),name:String(x.name||''),owned:!!x.owned,ownedAt:x.ownedAt||null}}
  function load(){try{const a=JSON.parse(localStorage.getItem(LS_KEY));if(Array.isArray(a))return a.map(normalize);return null}catch{return null}}
  let items=load()||FULL.map(x=>normalize(x));
  function save(){localStorage.setItem(LS_KEY,JSON.stringify(items)); if(fb.connected && !fb.applying) pushToCloudDebounced();}

  const app=document.getElementById('app');
  const btnPrint=document.getElementById('btnPrint');
  const btnCSVAll=document.getElementById('btnCSVAll');
  const btnToggleCfg=document.getElementById('btnToggleCfg');
  const cfgPanel=document.getElementById('cfgPanel');
  const cfgApiKey=document.getElementById('cfgApiKey');
  const cfgAuthDomain=document.getElementById('cfgAuthDomain');
  const cfgProjectId=document.getElementById('cfgProjectId');
  const cfgJson=document.getElementById('cfgJson');
  const cfgSave=document.getElementById('cfgSave');
  const cfgClear=document.getElementById('cfgClear');
  const cfgStatus=document.getElementById('cfgStatus');
  const familyCodeInput=document.getElementById('familyCode');
  const connectBtn=document.getElementById('connectBtn');
  const disconnectBtn=document.getElementById('disconnectBtn');
  const syncStatus=document.getElementById('syncStatus');

  /* ==================== 表表示 / CSV 用ユーティリティ ==================== */
  const by = k => (a,b)=> (a[k]||'').localeCompare(b[k]||'', 'ja');
  function sortForOutput(arr){
    // 地域→都道府県→名称（地域は定義順優先）
    return [...arr].sort((a,b)=>{
      const ra=(REGION_ORDER.indexOf(a.region)+1)||999;
      const rb=(REGION_ORDER.indexOf(b.region)+1)||999;
      return (ra-rb) || by('pref')(a,b) || by('name')(a,b);
    });
  }
  function csvCell(v){ const s=(v??'').toString().replace(/"/g,'""'); return /[,"\n]/.test(s)?'"'+s+'"':s; }
  function toCSV(data){
    const header=['地域','都道府県','名称','所持','所持日'];
    const rows=data.map(x=>[x.region,x.pref,x.name,x.owned?1:0,x.ownedAt||''].map(csvCell).join(','));
    return [header.join(','),...rows].join('\n');
  }
  function downloadBlob(filename, text, mime='text/csv;charset=utf-8;'){
    const blob=new Blob([text],{type:mime});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=filename;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  function exportCSV(data, filename='chiikawa_all.csv'){
    const sorted=sortForOutput(data);
    const csv=toCSV(sorted);
    downloadBlob(filename, csv);
  }

  /* ====== Live Server 対策版：document.writeもインライン<script>も使わない ====== */
  function openPrintAll() {
    const data = sortForOutput(items);
    const win = window.open('about:blank', '_blank', 'noopener');
    if (!win) { alert('ポップアップがブロックされています。許可してください。'); return; }

    const css = `
      :root{--text:#111;--border:#e5e7eb}
      body{font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Noto Sans JP,Meiryo,sans-serif;color:var(--text);margin:0;background:#fff}
      .wrap-n{max-width:1100px;margin:24px auto;padding:0 16px}
      h2{margin:0 0 12px;color:#0b1225}
      table.pretty{width:100%;border-collapse:collapse;border:1px solid var(--border)}
      table.pretty th,table.pretty td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
      thead th{background:#f8fafc}
      .b{display:inline-block;padding:2px 8px;border-radius:999px;font-weight:700;font-size:12px;border:1px solid #ddd}
      .b.yes{background:#ecfdf5;color:#065f46;border-color:#bbf7d0}
      .b.no{background:#fff1f2;color:#9f1239;border-color:#fecdd3}
      button{padding:8px 12px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer}
      @media print{#printBtn{display:none}}
    `;

    const build = () => {
      const doc = win.document;
      doc.title = 'ちいかわ 一覧';

      // head
      const style = doc.createElement('style');
      style.textContent = css;
      doc.head.appendChild(style);

      // body
      const wrap = doc.createElement('div');
      wrap.className = 'wrap-n';
      doc.body.appendChild(wrap);

      const h2 = doc.createElement('h2');
      h2.textContent = 'ちいかわ ご当地キーホルダー 一覧';
      wrap.appendChild(h2);

      const table = doc.createElement('table');
      table.className = 'pretty';
      const thead = doc.createElement('thead');
      const trh = doc.createElement('tr');
      ['地域','都道府県','名称','所持','所持日'].forEach(t => {
        const th = doc.createElement('th'); th.textContent = t; trh.appendChild(th);
      });
      thead.appendChild(trh);
      table.appendChild(thead);

      const tbody = doc.createElement('tbody');
      if (data.length === 0) {
        const tr = doc.createElement('tr');
        const td = doc.createElement('td'); td.colSpan = 5; td.textContent = 'データがありません';
        tr.appendChild(td); tbody.appendChild(tr);
      } else {
        data.forEach(x => {
          const tr = doc.createElement('tr');
          const td1 = doc.createElement('td'); td1.textContent = x.region;
          const td2 = doc.createElement('td'); td2.textContent = x.pref;
          const td3 = doc.createElement('td'); td3.textContent = x.name;
          const td4 = doc.createElement('td'); td4.style.textAlign = 'center';
          const badge = doc.createElement('span'); badge.className = 'b ' + (x.owned ? 'yes' : 'no');
          badge.textContent = x.owned ? '所持' : '未所持'; td4.appendChild(badge);
          const td5 = doc.createElement('td'); td5.textContent = x.ownedAt || '';
          tr.append(td1, td2, td3, td4, td5);
          tbody.appendChild(tr);
        });
      }
      table.appendChild(tbody);
      wrap.appendChild(table);

      const btnBox = doc.createElement('div');
      btnBox.style.textAlign = 'right';
      btnBox.style.marginTop = '10px';
      const printBtn = doc.createElement('button');
      printBtn.id = 'printBtn';
      printBtn.textContent = '🖨️ 印刷';
      printBtn.addEventListener('click', () => win.print());
      btnBox.appendChild(printBtn);
      wrap.appendChild(btnBox);
    };

    if (win.document.readyState === 'complete') build();
    else win.addEventListener('load', build);
  }

  /* ==================== イベント紐付け ==================== */
  btnPrint.addEventListener('click', openPrintAll);
  btnCSVAll.addEventListener('click', ()=>exportCSV(items,'chiikawa_all.csv'));

  if (btnToggleCfg && cfgPanel) {
    btnToggleCfg.addEventListener('click', () => {
      const hidden = getComputedStyle(cfgPanel).display === 'none';
      cfgPanel.style.display = hidden ? 'block' : 'none';
    });
  }

  /* ==================== Firebase関連 ==================== */
  const fb={app:null,auth:null,db:null,docRef:null,unsub:null,connected:false,applying:false,uid:null};
  const SAVED_CFG = JSON.parse(localStorage.getItem(CFG_KEY)||'{}');
  if(SAVED_CFG.apiKey){
    cfgApiKey.value=SAVED_CFG.apiKey||'';
    cfgAuthDomain.value=SAVED_CFG.authDomain||'';
    cfgProjectId.value=SAVED_CFG.projectId||'';
    cfgStatus.textContent='保存済みの設定を使用中';
  }
  cfgSave.addEventListener('click',()=>{
    let cfg=null;
    const txt=cfgJson.value.trim();
    if(txt){ try{ cfg=JSON.parse(txt);}catch(e){ return alert('JSONが不正です'); } }
    cfg = cfg || { apiKey: cfgApiKey.value.trim(), authDomain: cfgAuthDomain.value.trim(), projectId: cfgProjectId.value.trim() };
    if(!cfg.apiKey||!cfg.authDomain||!cfg.projectId) return alert('apiKey/authDomain/projectId を入力してください');
    localStorage.setItem(CFG_KEY, JSON.stringify(cfg));
    location.reload();
  });
  cfgClear.addEventListener('click',()=>{ localStorage.removeItem(CFG_KEY); location.reload(); });
  const FIREBASE_CONFIG = JSON.parse(localStorage.getItem(CFG_KEY)||'{}');

  function setStatus(t,cls=''){syncStatus.textContent=t;syncStatus.className='small '+cls}

  function ensureFirebase(){
    if(!FIREBASE_CONFIG.apiKey||!FIREBASE_CONFIG.projectId){ setStatus('設定未入力','warn'); return false; }
    if(!fb.app){
      fb.app = initializeApp(FIREBASE_CONFIG);
      fb.auth = getAuth(fb.app);
      fb.db = getFirestore(fb.app);
      onAuthStateChanged(fb.auth,u=>{fb.uid=u?u.uid:null});
    }
    return true;
  }

  function connect(){
    const code=(familyCodeInput.value||'').trim();
    if(!code) return alert('家族コードを入力してください。');
    if(!ensureFirebase()) return;
    setStatus('接続中…');
    signInAnonymously(fb.auth).then(async()=>{
      localStorage.setItem(FAMILY_KEY, code);
      fb.docRef = doc(getFirestore(fb.app),'families', code,'lists','default');
      const snap = await getDoc(fb.docRef);
      if(snap.exists()){
        fb.applying=true;
        const remote=(snap.data().items||[]).map(normalize);
        items = mergeItems(remote, items);
        save();
        fb.applying=false;
        render();
      }else{
        await setDoc(fb.docRef,{items, updatedAt: Date.now()});
      }
      if(fb.unsub) fb.unsub();
      fb.unsub = onSnapshot(fb.docRef, s=>{
        if(!s.exists()) return;
        const remote=(s.data().items||[]).map(normalize);
        fb.applying=true; items = mergeItems(remote, items); save(); fb.applying=false; render();
      });
      fb.connected=true; setStatus('同期中','ok');
    }).catch(e=>{console.error(e); setStatus('エラー','warn')});
  }
  function disconnect(){ if(fb.unsub) fb.unsub(); fb.unsub=null; fb.connected=false; fb.docRef=null; setStatus('未接続'); }
  connectBtn.addEventListener('click', connect);
  disconnectBtn.addEventListener('click', disconnect);

  let pushTimer=null;
  function pushToCloudDebounced(){ if(pushTimer) clearTimeout(pushTimer); pushTimer=setTimeout(()=>{ if(fb.docRef) setDoc(fb.docRef,{items, updatedAt: Date.now()}); },300); }

  function mergeItems(remote, local){
    const map=new Map();
    for(const it of local){ map.set(it.region+'__'+it.pref+'__'+it.name, it); }
    for(const it of remote){
      const k=it.region+'__'+it.pref+'__'+it.name;
      if(!map.has(k)) map.set(k, it);
      else{
        const a=map.get(k);
        map.set(k,{...a,...it,owned:!!(a.owned||it.owned),ownedAt:a.ownedAt||it.ownedAt||null});
      }
    }
    return [...map.values()].map(normalize);
  }

  function card(it){
    const d=document.createElement('div'); d.className='card';
    const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=!!it.owned;
    cb.addEventListener('change',()=>{it.owned=cb.checked;if(cb.checked&&!it.ownedAt)it.ownedAt=today();if(!cb.checked)it.ownedAt=null;save();render()});
    const name=document.createElement('span'); name.textContent=it.name;
    const dd=document.createElement('span'); dd.className='small'; dd.textContent=it.ownedAt?`(${it.ownedAt})`:'';
    d.appendChild(cb); d.appendChild(name); d.appendChild(dd); return d;
  }

  function render(){
    const app=document.getElementById('app'); app.innerHTML='';
    const frag=document.createDocumentFragment();
    const regions=[...new Set(items.map(it=>it.region))].sort((a,b)=>(REGION_ORDER.indexOf(a)+1||999)-(REGION_ORDER.indexOf(b)+1||999)||a.localeCompare(b,'ja'));
    for(const r of regions){
      const rItems=items.filter(it=>it.region===r);
      const ownR=rItems.filter(x=>x.owned).length;
      const details=document.createElement('details'); details.className='region'; details.open=(localStorage.getItem(LS_KEY+'_open_'+r)==='1');
      const summary=document.createElement('summary'); summary.textContent=`${r} ${ownR}/${rItems.length}`; details.appendChild(summary);
      const inner=document.createElement('div'); inner.className='inner';
      const byPref={}; for(const it of rItems){(byPref[it.pref]||(byPref[it.pref]=[])).push(it)}
      const prefNames=Object.keys(byPref).sort((a,b)=>a.localeCompare(b,'ja'));
      for(const p of prefNames){
        const sec=document.createElement('section'); sec.className='panel';
        const h2=document.createElement('h2'); const cnt=byPref[p].length; const own=byPref[p].filter(x=>x.owned).length; h2.textContent=`${p} ${own}/${cnt}`; sec.appendChild(h2);
        byPref[p].sort((a,b)=>(a.name||'').localeCompare(b.name||'','ja')).forEach(it=>sec.appendChild(card(it)));
        inner.appendChild(sec);
      }
      details.appendChild(inner);
      details.addEventListener('toggle',()=>localStorage.setItem(LS_KEY+'_open_'+r,details.open?'1':'0'));
      frag.appendChild(details);
    }
    app.appendChild(frag);
    const ownTotal=items.filter(x=>x.owned).length;
    document.getElementById('stats').textContent = `${ownTotal}/${items.length} 所持 (${items.length?Math.round(ownTotal/items.length*100):0}%)`;
  }

  // 初期描画
  render();

})();   // IIFE
</script>
</body>
</html>
