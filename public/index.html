<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ちいかわ ご当地キーホルダー 所持チェック（家族共有・Googleログイン）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#0f172a;--panel:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#22d3ee;--accent2:#a78bfa;--ok:#34d399}
    body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Noto Sans JP,Meiryo,sans-serif;background:#0b1225;color:var(--text)}
    header{position:sticky;top:0;background:#0f172a;z-index:10;border-bottom:1px solid #1f2937}
    .wrap{max-width:1100px;margin:auto;padding:12px}
    h1{margin:0 0 8px}
    input,select,button,textarea{margin:4px;padding:8px;border-radius:8px;border:1px solid #2b3a5d;background:#0b1327;color:var(--text)}
    button{cursor:pointer;background:linear-gradient(135deg,var(--accent2),var(--accent));border:none}
    .ghost{background:transparent;border:1px solid #2b3a5d}
    .small{font-size:12px;color:#94a3b8}
    details.region{margin:12px 0;border:1px solid #2b3a5d;border-radius:8px;overflow:hidden}
    details.region>summary{list-style:none;cursor:pointer;padding:10px 12px;background:#0b1327;font-weight:700;color:var(--accent)}
    details.region>summary::-webkit-details-marker{display:none}
    details.region .inner{padding:8px 12px;background:#0f172a}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .ok{color:#10b981}
    .warn{color:#f59e0b}
    .hide{display:none}
    /* ---- compact table view ---- */
    .tableWrap{margin:8px 0}
    .tbl{width:100%;border-collapse:collapse;border:1px solid #1f2937;background:#0b1327}
    .tbl th,.tbl td{padding:8px 10px;border-bottom:1px solid #1f2937;text-align:left}
    .tbl thead th{background:#0f172a;color:var(--muted);font-weight:600}
    .tbl tr:hover{background:#0e1832}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-weight:700;font-size:12px;border:1px solid #2b3a5d;margin-left:8px}
    .badge.yes{border-color:#065f46;color:#10b981;background:rgba(16,185,129,.08)}
    .small-muted{font-size:12px;color:#94a3b8;margin-left:8px}
  </style>
</head>
<body>
<header class="wrap">
  <h1>ちいかわ ご当地キーホルダー 所持チェック</h1>
  <div id="stats" class="small"></div>

  <div class="wrap row" style="margin-bottom:6px">
    <button id="btnPrint">一覧を表示/印刷</button>
    <button id="btnCSVAll">CSV (全件)</button>
    <span class="small" style="opacity:.85">地域→都道府県→名称で出力</span>
  </div>

  <!-- 認証UI -->
  <div class="wrap row" id="authRow">
    <button id="loginBtn" class="ghost">Googleでログイン</button>
    <button id="logoutBtn" class="ghost hide">ログアウト</button>
    <span id="userInfo" class="small"></span>
  </div>

  <!-- 家族コード＋同期UI -->
  <div class="wrap row" style="margin-top:6px">
    <input id="familyCode" placeholder="家族コード（例: my-family）" style="min-width:220px">
    <button id="connectBtn" class="ghost">同期オン</button>
    <button id="disconnectBtn" class="ghost">同期オフ</button>
    <span id="syncStatus" class="small">未接続</span>
  </div>
</header>

<main class="wrap" id="app"></main>

<!-- Firebase SDK を ES Modules で読み込み（v10系） -->
<script type="module">
/* ===== 都道府県順の定義 ===== */
const PREF_ORDER = [
  "北海道","青森","岩手","宮城","秋田","山形","福島",
  "茨城","栃木","群馬","埼玉","千葉","東京","神奈川",
  "新潟","富山","石川","福井","山梨","長野","岐阜","静岡","愛知",
  "三重","滋賀","京都","大阪","兵庫","奈良","和歌山",
  "鳥取","島根","岡山","広島","山口",
  "徳島","香川","愛媛","高知",
  "福岡","佐賀","長崎","熊本","大分","宮崎","鹿児島","沖縄"
];
const prefRank = (p)=>{const ix=PREF_ORDER.indexOf(p);return ix>=0?ix:999;};

/* ===== Firebase import ===== */
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js';
import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js';
import { getFirestore, doc, onSnapshot, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js';

(()=>{
  /* ===== 固定Firebase設定 ===== */
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyC66I66AmKfZFIyIKX_TXBSRTIsR2IDEDE",
    authDomain: "chiikawa-gotouchi-project.firebaseapp.com",
    projectId: "chiikawa-gotouchi-project",
    storageBucket: "chiikawa-gotouchi-project.appspot.com",
    messagingSenderId: "602616418153",
    appId: "1:602616418153:web:e73e4de1bf4942ee16b7f8"
  };

  /* ===== アプリ内状態 ===== */
  const LS_KEY='chiikawa-keyholders-v11';
  const FAMILY_KEY=LS_KEY+'__family';
  // 「沖縄地方」は使わない（九州地方に統一）
  const REGION_ORDER=[
    "北海道地方","東北地方","関東地方","中部地方","近畿地方",
    "中国地方","四国地方","九州地方","海外","その他"
  ];

  // ---- データ（沖縄は九州地方へ）----
  const FULL=[
    {region:"北海道地方",pref:"北海道",name:"北海道"},
    {region:"北海道地方",pref:"北海道",name:"ラベンダー"},
    {region:"北海道地方",pref:"北海道",name:"メロン"},
    {region:"北海道地方",pref:"北海道",name:"シマエナガ"},
    {region:"北海道地方",pref:"北海道",name:"くま"},
    {region:"北海道地方",pref:"北海道",name:"札幌テレビ塔"},
    {region:"北海道地方",pref:"北海道",name:"函館の夜景"},
    {region:"東北地方",pref:"青森",name:"ねぶた祭"},
    {region:"東北地方",pref:"青森",name:"りんご"},
    {region:"東北地方",pref:"岩手",name:"わんこそば"},
    {region:"東北地方",pref:"岩手",name:"銀河鉄道"},
    {region:"東北地方",pref:"宮城",name:"笹かま"},
    {region:"東北地方",pref:"宮城",name:"伊達政宗"},
    {region:"東北地方",pref:"宮城",name:"こけし"},
    {region:"東北地方",pref:"秋田",name:"秋田犬"},
    {region:"東北地方",pref:"秋田",name:"なまはげ"},
    {region:"東北地方",pref:"山形",name:"さくらんぼ"},
    {region:"東北地方",pref:"山形",name:"米沢牛"},
    {region:"東北地方",pref:"山形",name:"花笠"},
    {region:"東北地方",pref:"山形",name:"だだちゃ豆"},
    {region:"東北地方",pref:"福島",name:"赤べこ"},
    {region:"東北地方",pref:"福島",name:"ハワイアン"},
    {region:"東北地方",pref:"福島",name:"白虎隊"},
    {region:"東北地方",pref:"福島",name:"桃"},
    {region:"関東地方",pref:"茨城",name:"黄門様"},
    {region:"関東地方",pref:"茨城",name:"水戸納豆"},
    {region:"関東地方",pref:"栃木",name:"スカイベリー"},
    {region:"関東地方",pref:"栃木",name:"藤の花"},
    {region:"関東地方",pref:"栃木",name:"三猿"},
    {region:"関東地方",pref:"栃木",name:"関東・栃木レモン"},
    {region:"関東地方",pref:"群馬",name:"草津温泉"},
    {region:"関東地方",pref:"群馬",name:"だるま"},
    {region:"関東地方",pref:"群馬",name:"焼きまんじゅう"},
    {region:"関東地方",pref:"埼玉",name:"さつまいも"},
    {region:"関東地方",pref:"埼玉",name:"深谷ネギ"},
    {region:"関東地方",pref:"千葉",name:"落花生"},
    {region:"関東地方",pref:"東京",name:"雷門"},
    {region:"関東地方",pref:"東京",name:"東京パンダ"},
    {region:"関東地方",pref:"東京",name:"東京タワー"},
    {region:"関東地方",pref:"東京",name:"スカイツリー"},
    {region:"関東地方",pref:"東京",name:"東京駅丸の内駅舎"},
    {region:"関東地方",pref:"神奈川",name:"箱根温泉まんじゅう"},
    {region:"関東地方",pref:"神奈川",name:"横浜金の豚"},
    {region:"関東地方",pref:"神奈川",name:"鎌倉大仏さま"},
    {region:"関東地方",pref:"神奈川",name:"寄木細工"},
    {region:"関東地方",pref:"神奈川",name:"横浜カンフー"},
    {region:"関東地方",pref:"神奈川",name:"大涌谷黒たまご"},
    {region:"中部地方",pref:"新潟",name:"笹団子"},
    {region:"中部地方",pref:"新潟",name:"トキ"},
    {region:"中部地方",pref:"富山",name:"ホタルイカ"},
    {region:"中部地方",pref:"石川",name:"兼六園"},
    {region:"中部地方",pref:"福井",name:"恐竜"},
    {region:"中部地方",pref:"山梨",name:"ぶどう"},
    {region:"中部地方",pref:"長野",name:"信州りんご"},
    {region:"中部地方",pref:"長野",name:"信州オコジョ"},
    {region:"中部地方",pref:"岐阜",name:"合掌造り"},
    {region:"中部地方",pref:"岐阜",name:"さるぼぼ"},
    {region:"中部地方",pref:"静岡",name:"お茶"},
    {region:"中部地方",pref:"静岡",name:"みかん"},
    {region:"中部地方",pref:"静岡",name:"うなぎ"},
    {region:"中部地方",pref:"静岡",name:"いちご"},
    {region:"中部地方",pref:"静岡",name:"次郎長"},
    {region:"中部地方",pref:"静岡",name:"桜えび"},
    {region:"中部地方",pref:"富士山",name:"富士山"},
    {region:"中部地方",pref:"愛知",name:"しゃちほこ"},
    {region:"中部地方",pref:"愛知",name:"小倉トースト"},
    {region:"近畿地方",pref:"三重",name:"真珠"},
    {region:"近畿地方",pref:"三重",name:"伊勢エビ"},
    {region:"近畿地方",pref:"滋賀",name:"琵琶湖"},
    {region:"近畿地方",pref:"滋賀",name:"彦根城"},
    {region:"近畿地方",pref:"滋賀",name:"忍者"},
    {region:"近畿地方",pref:"滋賀",name:"信楽たぬき"},
    {region:"近畿地方",pref:"京都",name:"八ッ橋"},
    {region:"近畿地方",pref:"京都",name:"新選組"},
    {region:"近畿地方",pref:"京都",name:"伏見稲荷"},
    {region:"近畿地方",pref:"京都",name:"抹茶ソフト"},
    {region:"近畿地方",pref:"京都",name:"金閣寺"},
    {region:"近畿地方",pref:"京都",name:"ニデック京都タワー"},
    {region:"近畿地方",pref:"大阪",name:"たこ焼"},
    {region:"近畿地方",pref:"大阪",name:"通天閣"},
    {region:"近畿地方",pref:"大阪",name:"大阪のおばちゃん"},
    {region:"近畿地方",pref:"大阪",name:"大阪城"},
    {region:"近畿地方",pref:"大阪",name:"ミックスジュース"},
    {region:"近畿地方",pref:"兵庫",name:"神戸セーラー"},
    {region:"近畿地方",pref:"兵庫",name:"神戸中華街"},
    {region:"近畿地方",pref:"兵庫",name:"淡路玉ねぎ"},
    {region:"近畿地方",pref:"兵庫",name:"神戸ポートタワー"},
    {region:"近畿地方",pref:"兵庫",name:"姫路千姫"},
    {region:"近畿地方",pref:"兵庫",name:"コウノトリ"},
    {region:"近畿地方",pref:"奈良",name:"鹿"},
    {region:"近畿地方",pref:"奈良",name:"大仏"},
    {region:"近畿地方",pref:"和歌山",name:"パンダ"},
    {region:"近畿地方",pref:"和歌山",name:"みかん"},
    {region:"四国地方",pref:"鳴門",name:"渦潮"},
    {region:"四国地方",pref:"香川",name:"さぬきうどん"},
    {region:"四国地方",pref:"愛媛",name:"みかん"},
    {region:"四国地方",pref:"高知",name:"坂本龍馬"},
    {region:"中国地方",pref:"瀬戸内",name:"瀬戸内レモン"},
    {region:"中国地方",pref:"島根",name:"縁結び"},
    {region:"中国地方",pref:"岡山",name:"桃太郎"},
    {region:"中国地方",pref:"岡山",name:"桃から生まれた桃太郎"},
    {region:"中国地方",pref:"広島",name:"もみじ饅頭"},
    {region:"中国地方",pref:"広島",name:"宮島の鹿"},
    {region:"中国地方",pref:"広島",name:"尾道ラーメン"},
    {region:"中国地方",pref:"広島",name:"お好み焼"},
    {region:"中国地方",pref:"宮島",name:"しゃもじ"},
    {region:"中国地方",pref:"山口",name:"ふく"},
    {region:"中国地方",pref:"山陰",name:"いなばの白うさぎ"},
    {region:"九州地方",pref:"福岡",name:"あまおう"},
    {region:"九州地方",pref:"福岡",name:"明太子"},
    {region:"九州地方",pref:"福岡",name:"とんこつラーメン"},
    {region:"九州地方",pref:"福岡",name:"北九州バナナの叩き売り"},
    {region:"九州地方",pref:"福岡",name:"にわか"},
    {region:"九州地方",pref:"佐賀",name:"バルーン"},
    {region:"九州地方",pref:"長崎",name:"カステラ"},
    {region:"九州地方",pref:"熊本",name:"熊本城"},
    {region:"九州地方",pref:"熊本",name:"辛子れんこん"},
    {region:"九州地方",pref:"熊本",name:"すいか"},
    {region:"九州地方",pref:"宮崎",name:"マンゴー"},
    {region:"九州地方",pref:"宮崎",name:"サーフィン"},
    {region:"九州地方",pref:"大分",name:"温泉"},
    {region:"九州地方",pref:"鹿児島",name:"黒豚"},
    {region:"九州地方",pref:"鹿児島",name:"桜島"},
    {region:"九州地方",pref:"鹿児島",name:"氷しろくま"},
    {region:"九州地方",pref:"沖縄",name:"シーサー"},
    {region:"九州地方",pref:"沖縄",name:"ジンベエザメ"},
    {region:"九州地方",pref:"沖縄",name:"紅いもタルト"},
    {region:"九州地方",pref:"奄美",name:"アマミノクロウサギ"},
    {region:"その他",pref:"温泉地",name:"温泉"},
    {region:"その他",pref:"リゾート",name:"スキー冬季限定"},
    {region:"その他",pref:"リゾート",name:"スノボー冬季限定"},
    {region:"その他",pref:"JR東日本",name:"はやぶさ"},
    {region:"その他",pref:"JR東日本",name:"E7"},
    {region:"その他",pref:"JR東海・西日本",name:"N700S"},
    {region:"その他",pref:"JR東海・西日本",name:"Dr.Yellow"},
    {region:"その他",pref:"空港",name:"パイロット"},
    {region:"海外",pref:"マカオ",name:"セントポール"},
    {region:"海外",pref:"マカオ",name:"エッグタルト"},
    {region:"海外",pref:"マカオ",name:"アズレージョ"},
    {region:"海外",pref:"香港",name:"エッグワッフル"},
    {region:"海外",pref:"香港",name:"ビクトリアハーバー"},
    {region:"海外",pref:"香港",name:"カンフー"},
    {region:"海外",pref:"オーストラリア",name:"コアラ"},
    {region:"海外",pref:"オーストラリア",name:"カンガルー"}
  ];

  // --- 旧データに「沖縄地方」が残っていても九州地方へマップする ---
  function migrateRegion(v){ return v==="沖縄地方" ? "九州地方" : v; }

  function today(){const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
  function normalize(x){
    return{
      region:migrateRegion(String(x.region||'')),
      pref:String(x.pref||''),
      name:String(x.name||''),
      owned:!!x.owned,
      ownedAt:x.ownedAt||null
    };
  }
  function load(){try{const a=JSON.parse(localStorage.getItem(LS_KEY));if(Array.isArray(a))return a.map(normalize);return null}catch{return null}}
  let items=load()||FULL.map(x=>normalize(x));

  function setStatus(t,cls=''){ syncStatus.textContent=t; syncStatus.className='small '+(cls||''); }

  /* ===== UI要素 ===== */
  const app=document.getElementById('app');
  const btnPrint=document.getElementById('btnPrint');
  const btnCSVAll=document.getElementById('btnCSVAll');
  const familyCodeInput=document.getElementById('familyCode');
  const connectBtn=document.getElementById('connectBtn');
  const disconnectBtn=document.getElementById('disconnectBtn');
  const syncStatus=document.getElementById('syncStatus');
  const loginBtn=document.getElementById('loginBtn');
  const logoutBtn=document.getElementById('logoutBtn');
  const userInfo=document.getElementById('userInfo');

  /* ===== Firebase 初期化・認証 ===== */
  const fb={app:null,auth:null,db:null,docRef:null,unsub:null,connected:false,applying:false,uid:null};
  fb.app = initializeApp(FIREBASE_CONFIG);
  fb.auth = getAuth(fb.app);
  fb.db = getFirestore(fb.app);
  const provider = new GoogleAuthProvider();

  loginBtn.addEventListener('click', async () => {
    try{ await signInWithPopup(fb.auth, provider); }
    catch(e){ console.error('login error', e); setStatus('ログイン失敗','warn'); alert('ログインに失敗しました: ' + (e.code || e.message)); }
  });
  logoutBtn.addEventListener('click', async () => {
    try{ await signOut(fb.auth); } catch(e){ console.error('logout error', e); }
  });

  // ---- Firestore 同期 ----
  function disconnect(){
    if(fb.unsub) fb.unsub();
    fb.unsub=null; fb.connected=false; fb.docRef=null; setStatus('未接続');
  }
  function showError(prefix, e){
    console.error(prefix, e);
    const msg=(e && (e.code||e.message))?` (${e.code||e.message})`:'';
    setStatus(`エラー${msg}`,'warn');
  }
  function ensureLoggedIn(){
    if(!fb.auth.currentUser){ alert('まず Google でログインしてください。'); return false; }
    return true;
  }
  function mergeItems(remote, local){
    // 正規化＋地域移行を両方に適用
    const map=new Map();
    for(const it of local.map(normalize)){
      map.set(it.region+'__'+it.pref+'__'+it.name, it);
    }
    for(const it0 of remote){
      const it=normalize(it0);
      const k=it.region+'__'+it.pref+'__'+it.name;
      if(!map.has(k)) map.set(k, it);
      else{
        const a=map.get(k);
        map.set(k,{...a,...it,owned:!!(a.owned||it.owned),ownedAt:a.ownedAt||it.ownedAt||null});
      }
    }
    return [...map.values()];
  }
  let pushTimer=null;
  function pushToCloudDebounced(){
    if(pushTimer) clearTimeout(pushTimer);
    pushTimer=setTimeout(()=>{ if(fb.docRef) setDoc(fb.docRef,{items, updatedAt: Date.now()}); },300);
  }
  function save(){
    localStorage.setItem(LS_KEY,JSON.stringify(items));
    if(fb.connected && !fb.applying) pushToCloudDebounced();
  }
  function connect(){
    if(!ensureLoggedIn()) return;
    const code=(familyCodeInput.value||'').trim();
    if(!code) return alert('家族コードを入力してください。');
    setStatus('接続中…');
    localStorage.setItem(FAMILY_KEY, code);

    fb.docRef = doc(fb.db,'families', code,'lists','default');

    getDoc(fb.docRef).then(async (snap)=>{
      if(snap.exists()){
        fb.applying=true;
        const remote=(snap.data().items||[]).map(normalize);
        items = mergeItems(remote, items);
        save();
        fb.applying=false;
        render();
      }else{
        await setDoc(fb.docRef,{items, updatedAt: Date.now()});
      }
      if(fb.unsub) fb.unsub();
      fb.unsub = onSnapshot(fb.docRef, s=>{
        if(!s.exists()) return;
        const remote=(s.data().items||[]).map(normalize);
        fb.applying=true; items = mergeItems(remote, items); save(); fb.applying=false; render();
      }, e=>showError('onSnapshot失敗', e));

      fb.connected=true; setStatus('同期中','ok');
    }).catch(e=>showError('getDoc失敗', e));
  }

  connectBtn.addEventListener('click', connect);
  disconnectBtn.addEventListener('click', disconnect);

  onAuthStateChanged(fb.auth, (u) => {
    fb.uid = u ? u.uid : null;
    if(u){
      loginBtn.classList.add('hide');
      logoutBtn.classList.remove('hide');
      userInfo.textContent = `ログイン中: ${u.email||u.uid}`;
      setStatus('ログイン済み');
      const saved = localStorage.getItem(FAMILY_KEY)||'';
      if(saved && !familyCodeInput.value) familyCodeInput.value = saved;
    }else{
      loginBtn.classList.remove('hide');
      logoutBtn.classList.add('hide');
      userInfo.textContent = '';
      setStatus('未接続');
      disconnect();
    }
  });

  /* ===== CSV/印刷ユーティリティ ===== */
  function sortForOutput(arr){
    return [...arr].sort((a,b)=>{
      const ra=(REGION_ORDER.indexOf(a.region)+1)||999;
      const rb=(REGION_ORDER.indexOf(b.region)+1)||999;
      if(ra!==rb) return ra-rb;
      const pa=prefRank(a.pref), pb=prefRank(b.pref);
      if(pa!==pb) return pa-pb;
      return (a.name||'').localeCompare(b.name||'','ja');
    });
  }
  function csvCell(v){ const s=(v??'').toString().replace(/"/g,'""'); return /[,"\n]/.test(s)?'"'+s+'"':s; }
  function toCSV(data){
    const header=['地域','都道府県','名称','所持','所持日'];
    const rows=data.map(x=>[x.region,x.pref,x.name,x.owned?1:0,x.ownedAt||''].map(csvCell).join(','));
    return ['\ufeff'+header.join(','),...rows].join('\n');
  }
  function downloadBlob(filename, text, mime='text/csv;charset=utf-8;'){
    const blob=new Blob([text],{type:mime});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=filename;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  function exportCSV(data, filename='chiikawa_all.csv'){
    const sorted=sortForOutput(data);
    const csv=toCSV(sorted);
    downloadBlob(filename, csv);
  }
  btnCSVAll.addEventListener('click', ()=>exportCSV(items,'chiikawa_all.csv'));

  function openPrintAll() {
    const data = sortForOutput(items);
    const win = window.open('about:blank', '_blank', 'noopener');
    if (!win) { alert('ポップアップがブロックされています。許可してください。'); return; }
    const css = `
      :root{--text:#111;--border:#e5e7eb}
      body{font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Noto Sans JP,Meiryo,sans-serif;color:#111;margin:0;background:#fff}
      .wrap-n{max-width:1100px;margin:24px auto;padding:0 16px}
      h2{margin:0 0 12px;color:#0b1225}
      table.pretty{width:100%;border-collapse:collapse;border:1px solid var(--border)}
      table.pretty th,table.pretty td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
      thead th{background:#f8fafc}
      .b{display:inline-block;padding:2px 8px;border-radius:999px;font-weight:700;font-size:12px;border:1px solid #ddd}
      .b.yes{background:#ecfdf5;color:#065f46;border-color:#bbf7d0}
      .b.no{background:#fff1f2;color:#9f1239;border-color:#fecdd3}
      button{padding:8px 12px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer}
      @media print{#printBtn{display:none}}
    `;
    const build = () => {
      const doc = win.document;
      doc.title = 'ちいかわ 一覧';
      const style = doc.createElement('style'); style.textContent = css; doc.head.appendChild(style);
      const wrap = doc.createElement('div'); wrap.className = 'wrap-n'; doc.body.appendChild(wrap);
      const h2 = doc.createElement('h2'); h2.textContent = 'ちいかわ ご当地キーホルダー 一覧'; wrap.appendChild(h2);
      const table = doc.createElement('table'); table.className='pretty';
      const thead = doc.createElement('thead'); const trh = document.createElement('tr');
      ['地域','都道府県','名称','所持','所持日'].forEach(t=>{const th=document.createElement('th'); th.textContent=t; trh.appendChild(th);});
      thead.appendChild(trh); table.appendChild(thead);
      const tbody = document.createElement('tbody');
      if(data.length===0){
        const tr=document.createElement('tr'); const td=document.createElement('td'); td.colSpan=5; td.textContent='データがありません'; tr.appendChild(td); tbody.appendChild(tr);
      }else{
        data.forEach(x=>{
          const tr=document.createElement('tr');
          const td1=document.createElement('td'); td1.textContent=x.region;
          const td2=document.createElement('td'); td2.textContent=x.pref;
          const td3=document.createElement('td'); td3.textContent=x.name;
          const td4=document.createElement('td'); td4.style.textAlign='center'; const badge=document.createElement('span'); badge.className='b '+(x.owned?'yes':'no'); badge.textContent=x.owned?'所持':'未所持'; td4.appendChild(badge);
          const td5=document.createElement('td'); td5.textContent=x.ownedAt||'';
          tr.append(td1,td2,td3,td4,td5); tbody.appendChild(tr);
        });
      }
      table.appendChild(tbody); wrap.appendChild(table);
      const btnBox = document.createElement('div'); btnBox.style.textAlign='right'; btnBox.style.marginTop='10px';
      const printBtn = document.createElement('button'); printBtn.id='printBtn'; printBtn.textContent='🖨️ 印刷'; printBtn.addEventListener('click', ()=>win.print());
      btnBox.appendChild(printBtn); wrap.appendChild(btnBox);
    };
    if (win.document.readyState === 'complete') build(); else win.addEventListener('load', build);
  }
  btnPrint.addEventListener('click', openPrintAll);

  /* ===== 画面描画（2カラム） ===== */
  function render(){
    app.innerHTML='';
    const frag=document.createDocumentFragment();
    const regions=[...new Set(items.map(it=>it.region))]
      .map(migrateRegion)
      .sort((a,b)=>(REGION_ORDER.indexOf(a)+1||999)-(REGION_ORDER.indexOf(b)+1||999)||a.localeCompare(b,'ja'));

    for(const r of regions){
      const rItems=items.filter(it=>migrateRegion(it.region)===r);
      const ownR=rItems.filter(x=>x.owned).length;

      const details=document.createElement('details');
      details.className='region';
      details.open=(localStorage.getItem(LS_KEY+'_open_'+r)==='1');

      const summary=document.createElement('summary');
      summary.textContent=`${r} ${ownR}/${rItems.length}`;
      details.appendChild(summary);

      const inner=document.createElement('div');
      inner.className='inner';

      // 都道府県でグルーピング → 47都道府県順
      const byPref={};
      for(const it0 of rItems){
        const it=normalize(it0);
        (byPref[it.pref]||(byPref[it.pref]=[])).push(it);
      }
      const prefNames=Object.keys(byPref).sort((a,b)=>{
        const ra=prefRank(a), rb=prefRank(b);
        return (ra-rb) || a.localeCompare(b,'ja');
      });

      // 2カラムテーブル
      const wrap=document.createElement('div'); wrap.className='tableWrap';
      const table=document.createElement('table'); table.className='tbl';
      const thead=document.createElement('thead'); const trh=document.createElement('tr');
      ["都道府県","名称"].forEach(t=>{const th=document.createElement('th'); th.textContent=t; trh.appendChild(th);});
      thead.appendChild(trh); table.appendChild(thead);

      const tbody=document.createElement('tbody');
      for(const p of prefNames){
        const rows=byPref[p].sort((a,b)=>(a.name||'').localeCompare(b.name||'','ja'));
        rows.forEach((it,idx)=>{
          const tr=document.createElement('tr');

          const tdPref=document.createElement('td');
          if(idx===0){ tdPref.textContent=p; tdPref.style.whiteSpace='nowrap'; } else { tdPref.textContent=''; }
          tr.appendChild(tdPref);

          const tdName=document.createElement('td');
          const rowBox=document.createElement('div'); rowBox.className='row';

          const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=!!it.owned;
          cb.addEventListener('change',()=>{
            it.owned=cb.checked;
            if(cb.checked && !it.ownedAt) it.ownedAt=today();
            if(!cb.checked) it.ownedAt=null;
            save(); render();
          });

          const nameSpan=document.createElement('span'); nameSpan.textContent=it.name;
          const ownedBadge=document.createElement('span'); ownedBadge.className='badge'+(it.owned?' yes':''); ownedBadge.textContent=it.owned?'所持':'未所持';
          const dateSmall=document.createElement('span'); dateSmall.className='small-muted'; dateSmall.textContent = it.ownedAt ? `(${it.ownedAt})` : '';

          rowBox.append(cb, nameSpan, ownedBadge, dateSmall);
          tdName.appendChild(rowBox);
          tr.appendChild(tdName);

          tbody.appendChild(tr);
        });
      }

      table.appendChild(tbody); wrap.appendChild(table); inner.appendChild(wrap);
      details.appendChild(inner);
      details.addEventListener('toggle',()=>localStorage.setItem(LS_KEY+'_open_'+r,details.open?'1':'0'));
      frag.appendChild(details);
    }

    app.appendChild(frag);

    const ownTotal=items.filter(x=>x.owned).length;
    document.getElementById('stats').textContent =
      `${ownTotal}/${items.length} 所持 (${items.length?Math.round(ownTotal/items.length*100):0}%)`;
  }

  // 初期描画（家族コード復元）
  const savedFamily = localStorage.getItem(FAMILY_KEY)||'';
  if(savedFamily) familyCodeInput.value = savedFamily;
  render();
})(); // IIFE
</script>
</body>
</html>
