<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã¡ã„ã‹ã‚ ã”å½“åœ°ã‚­ãƒ¼ãƒ›ãƒ«ãƒ€ãƒ¼ æ‰€æŒãƒã‚§ãƒƒã‚¯ï¼ˆå®¶æ—å…±æœ‰ãƒ»Googleãƒ­ã‚°ã‚¤ãƒ³ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#0f172a;--panel:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#22d3ee;--accent2:#a78bfa;--ok:#34d399}
    body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Noto Sans JP,Meiryo,sans-serif;background:#0b1225;color:var(--text)}
    header{position:sticky;top:0;background:#0f172a;z-index:10;border-bottom:1px solid #1f2937}
    .wrap{max-width:1100px;margin:auto;padding:12px}
    h1{margin:0 0 8px}
    input,select,button,textarea{margin:4px;padding:8px;border-radius:8px;border:1px solid #2b3a5d;background:#0b1327;color:var(--text)}
    button{cursor:pointer;background:linear-gradient(135deg,var(--accent2),var(--accent));border:none}
    .ghost{background:transparent;border:1px solid #2b3a5d}
    .panel{background:#111827;margin:12px 0;padding:10px;border-radius:10px}
    .small{font-size:12px;color:#94a3b8}
    .card{background:#0b1327;padding:8px;margin:6px 0;border-radius:6px;display:flex;align-items:center;gap:8px}
    details.region{margin:12px 0;border:1px solid #2b3a5d;border-radius:8px;overflow:hidden}
    details.region>summary{list-style:none;cursor:pointer;padding:10px 12px;background:#0b1327;font-weight:700;color:var(--accent)}
    details.region>summary::-webkit-details-marker{display:none}
    details.region .inner{padding:8px 12px;background:#0f172a}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .ok{color:#10b981}
    .warn{color:#f59e0b}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:8px}
    .hide{display:none}
  </style>
</head>
<body>
<header class="wrap">
  <h1>ã¡ã„ã‹ã‚ ã”å½“åœ°ã‚­ãƒ¼ãƒ›ãƒ«ãƒ€ãƒ¼ æ‰€æŒãƒã‚§ãƒƒã‚¯</h1>
  <div id="stats" class="small"></div>

  <div class="wrap row" style="margin-bottom:6px">
    <button id="btnPrint">ä¸€è¦§ã‚’è¡¨ç¤º/å°åˆ·</button>
    <button id="btnCSVAll">CSV (å…¨ä»¶)</button>
    <span class="small" style="opacity:.85">åœ°åŸŸâ†’éƒ½é“åºœçœŒâ†’åç§°ã§å‡ºåŠ›</span>
  </div>

  <!-- èªè¨¼UI -->
  <div class="wrap row" id="authRow">
    <button id="loginBtn" class="ghost">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
    <button id="logoutBtn" class="ghost hide">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    <span id="userInfo" class="small"></span>
  </div>

  <!-- å®¶æ—ã‚³ãƒ¼ãƒ‰ï¼‹åŒæœŸUI -->
  <div class="wrap row" style="margin-top:6px">
    <input id="familyCode" placeholder="å®¶æ—ã‚³ãƒ¼ãƒ‰ï¼ˆä¾‹: my-familyï¼‰" style="min-width:220px">
    <button id="connectBtn" class="ghost">åŒæœŸã‚ªãƒ³</button>
    <button id="disconnectBtn" class="ghost">åŒæœŸã‚ªãƒ•</button>
    <span id="syncStatus" class="small">æœªæ¥ç¶š</span>
  </div>
</header>

<main class="wrap" id="app"></main>

<!-- Firebase SDK ã‚’ ES Modules ã§èª­ã¿è¾¼ã¿ï¼ˆv10ç³»ï¼‰ -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js';
import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js';
import { getFirestore, doc, onSnapshot, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js';

(()=>{
  /* ===== å›ºå®šFirebaseè¨­å®šï¼ˆè¨­å®šãƒ‘ãƒãƒ«ã¯ä¸è¦ï¼‰ ===== */
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyC66I66AmKfZFIyIKX_TXBSRTIsR2IDEDE",
    authDomain: "chiikawa-gotouchi-project.firebaseapp.com",
    projectId: "chiikawa-gotouchi-project",
    storageBucket: "chiikawa-gotouchi-project.appspot.com",
    messagingSenderId: "602616418153",
    appId: "1:602616418153:web:e73e4de1bf4942ee16b7f8"
  };

  /* ===== ã‚¢ãƒ—ãƒªå†…çŠ¶æ…‹ ===== */
  const LS_KEY='chiikawa-keyholders-v11';
  const FAMILY_KEY=LS_KEY+'__family';
  const REGION_ORDER=["åŒ—æµ·é“åœ°æ–¹","æ±åŒ—åœ°æ–¹","é–¢æ±åœ°æ–¹","ä¸­éƒ¨åœ°æ–¹","è¿‘ç•¿åœ°æ–¹","ä¸­å›½åœ°æ–¹","å››å›½åœ°æ–¹","ä¹å·åœ°æ–¹","æµ·å¤–","ãã®ä»–"];
  const FULL=[
    {region:"åŒ—æµ·é“åœ°æ–¹",pref:"åŒ—æµ·é“",name:"åŒ—æµ·é“"},
    {region:"åŒ—æµ·é“åœ°æ–¹",pref:"åŒ—æµ·é“",name:"ãƒ©ãƒ™ãƒ³ãƒ€ãƒ¼"},
    {region:"åŒ—æµ·é“åœ°æ–¹",pref:"åŒ—æµ·é“",name:"ãƒ¡ãƒ­ãƒ³"},
    {region:"åŒ—æµ·é“åœ°æ–¹",pref:"åŒ—æµ·é“",name:"ãƒã‚·ãƒã‚¬"},
    {region:"æ±åŒ—åœ°æ–¹",pref:"é’æ£®çœŒ",name:"ã­ã¶ãŸç¥­"},
    {region:"æ±åŒ—åœ°æ–¹",pref:"å²©æ‰‹çœŒ",name:"ã‚ã‚“ã“ãã°"},
    {region:"æ±åŒ—åœ°æ–¹",pref:"å®®åŸçœŒ",name:"ä¼Šé”æ”¿å®—"},
    {region:"æ±åŒ—åœ°æ–¹",pref:"ç§‹ç”°çœŒ",name:"ç§‹ç”°çŠ¬"},
    {region:"æ±åŒ—åœ°æ–¹",pref:"å±±å½¢çœŒ",name:"ã•ãã‚‰ã‚“ã¼"},
    {region:"æ±åŒ—åœ°æ–¹",pref:"ç¦å³¶çœŒ",name:"èµ¤ã¹ã“"},
    {region:"é–¢æ±åœ°æ–¹",pref:"æ±äº¬éƒ½",name:"æ±äº¬ã‚¿ãƒ¯ãƒ¼"},
    {region:"é–¢æ±åœ°æ–¹",pref:"æ±äº¬éƒ½",name:"é›·é–€"},
    {region:"é–¢æ±åœ°æ–¹",pref:"åŸ¼ç‰çœŒ",name:"ã•ã¤ã¾ã„ã‚‚"},
    {region:"é–¢æ±åœ°æ–¹",pref:"åƒè‘‰çœŒ",name:"è½èŠ±ç”Ÿ"},
    {region:"é–¢æ±åœ°æ–¹",pref:"ç¥å¥ˆå·çœŒ",name:"å´é™½è»’ã‚·ã‚¦ãƒã‚¤"},
    {region:"ä¸­éƒ¨åœ°æ–¹",pref:"æ–°æ½ŸçœŒ",name:"ç¬¹å›£å­"},
    {region:"ä¸­éƒ¨åœ°æ–¹",pref:"é•·é‡çœŒ",name:"ä¿¡å·ã‚Šã‚“ã”"},
    {region:"ä¸­éƒ¨åœ°æ–¹",pref:"é™å²¡çœŒ",name:"å¯Œå£«å±±"},
    {region:"ä¸­éƒ¨åœ°æ–¹",pref:"æ„›çŸ¥çœŒ",name:"ã²ã¤ã¾ã¶ã—"},
    {region:"è¿‘ç•¿åœ°æ–¹",pref:"å¤§é˜ªåºœ",name:"ãŸã“ç„¼ã"},
    {region:"è¿‘ç•¿åœ°æ–¹",pref:"å…µåº«çœŒ",name:"ç¥æˆ¸ç‰›"},
    {region:"è¿‘ç•¿åœ°æ–¹",pref:"äº¬éƒ½åºœ",name:"å…«ãƒ„æ©‹"},
    {region:"ä¸­å›½åœ°æ–¹",pref:"åºƒå³¶çœŒ",name:"åºƒå³¶é¢¨ãŠå¥½ã¿ç„¼ã"},
    {region:"ä¸­å›½åœ°æ–¹",pref:"å²¡å±±çœŒ",name:"ãã³ã ã‚“ã”"},
    {region:"å››å›½åœ°æ–¹",pref:"é¦™å·çœŒ",name:"è®ƒå²ã†ã©ã‚“"},
    {region:"å››å›½åœ°æ–¹",pref:"æ„›åª›çœŒ",name:"ã¿ã‹ã‚“"},
    {region:"ä¹å·åœ°æ–¹",pref:"ç¦å²¡çœŒ",name:"æ˜å¤ªå­"},
    {region:"ä¹å·åœ°æ–¹",pref:"é•·å´çœŒ",name:"ã‚«ã‚¹ãƒ†ãƒ©"},
    {region:"ä¹å·åœ°æ–¹",pref:"é¹¿å…å³¶çœŒ",name:"é»’è±š"},
    {region:"ä¹å·åœ°æ–¹",pref:"æ²–ç¸„çœŒ",name:"ã‚·ãƒ¼ã‚µãƒ¼"},
    {region:"æµ·å¤–",pref:"é¦™æ¸¯",name:"ã‚¨ãƒƒã‚°ã‚¿ãƒ«ãƒˆ"},
    {region:"æµ·å¤–",pref:"ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢",name:"ã‚³ã‚¢ãƒ©"},
    {region:"ãã®ä»–",pref:"JRæ±æ—¥æœ¬",name:"E7"},
    {region:"ãã®ä»–",pref:"JRè¥¿æ—¥æœ¬",name:"N700S"},
    {region:"ãã®ä»–",pref:"ç©ºæ¸¯",name:"ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ"}
  ];
  function today(){const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
  function normalize(x){return{region:String(x.region||''),pref:String(x.pref||''),name:String(x.name||''),owned:!!x.owned,ownedAt:x.ownedAt||null}}
  function load(){try{const a=JSON.parse(localStorage.getItem(LS_KEY));if(Array.isArray(a))return a.map(normalize);return null}catch{return null}}
  let items=load()||FULL.map(x=>normalize(x));
  function save(){localStorage.setItem(LS_KEY,JSON.stringify(items)); if(fb.connected && !fb.applying) pushToCloudDebounced();}

  /* ===== UIè¦ç´  ===== */
  const app=document.getElementById('app');
  const btnPrint=document.getElementById('btnPrint');
  const btnCSVAll=document.getElementById('btnCSVAll');
  const familyCodeInput=document.getElementById('familyCode');
  const connectBtn=document.getElementById('connectBtn');
  const disconnectBtn=document.getElementById('disconnectBtn');
  const syncStatus=document.getElementById('syncStatus');
  const loginBtn=document.getElementById('loginBtn');
  const logoutBtn=document.getElementById('logoutBtn');
  const userInfo=document.getElementById('userInfo');

  /* ===== Firebase åˆæœŸåŒ–ãƒ»èªè¨¼ ===== */
  const fb={app:null,auth:null,db:null,docRef:null,unsub:null,connected:false,applying:false,uid:null};
  fb.app = initializeApp(FIREBASE_CONFIG);
  fb.auth = getAuth(fb.app);
  fb.db = getFirestore(fb.app);

  const provider = new GoogleAuthProvider();

  loginBtn.addEventListener('click', async () => {
    try{
      await signInWithPopup(fb.auth, provider);
    }catch(e){
      console.error('login error', e);
      setStatus('ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—', 'warn');
      alert('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e.code || e.message));
    }
  });
  logoutBtn.addEventListener('click', async () => {
    try{
      await signOut(fb.auth);
    }catch(e){
      console.error('logout error', e);
    }
  });

  onAuthStateChanged(fb.auth, (u) => {
    fb.uid = u ? u.uid : null;
    if(u){
      loginBtn.classList.add('hide');
      logoutBtn.classList.remove('hide');
      userInfo.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${u.email||u.uid}`;
      setStatus('ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿');
      // ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã—ã¦ãŸå®¶æ—ã‚³ãƒ¼ãƒ‰ã‚’å¾©å…ƒ
      const saved = localStorage.getItem(FAMILY_KEY)||'';
      if(saved && !familyCodeInput.value) familyCodeInput.value = saved;
    }else{
      loginBtn.classList.remove('hide');
      logoutBtn.classList.add('hide');
      userInfo.textContent = '';
      setStatus('æœªæ¥ç¶š');
      // åˆ‡æ–­
      disconnect();
    }
  });

  /* ===== è¡¨/CSVãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
  const by = k => (a,b)=> (a[k]||'').localeCompare(b[k]||'', 'ja');
  function sortForOutput(arr){
    return [...arr].sort((a,b)=>{
      const ra=(REGION_ORDER.indexOf(a.region)+1)||999;
      const rb=(REGION_ORDER.indexOf(b.region)+1)||999;
      return (ra-rb) || by('pref')(a,b) || by('name')(a,b);
    });
  }
  function csvCell(v){ const s=(v??'').toString().replace(/"/g,'""'); return /[,"\n]/.test(s)?'"'+s+'"':s; }
  function toCSV(data){
    const header=['åœ°åŸŸ','éƒ½é“åºœçœŒ','åç§°','æ‰€æŒ','æ‰€æŒæ—¥'];
    const rows=data.map(x=>[x.region,x.pref,x.name,x.owned?1:0,x.ownedAt||''].map(csvCell).join(','));
    return ['\ufeff'+header.join(','),...rows].join('\n'); // BOMä»˜ãï¼ˆExcelå¯¾ç­–ï¼‰
  }
  function downloadBlob(filename, text, mime='text/csv;charset=utf-8;'){
    const blob=new Blob([text],{type:mime});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=filename;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  function exportCSV(data, filename='chiikawa_all.csv'){
    const sorted=sortForOutput(data);
    const csv=toCSV(sorted);
    downloadBlob(filename, csv);
  }

  function openPrintAll() {
    const data = sortForOutput(items);
    const win = window.open('about:blank', '_blank', 'noopener');
    if (!win) { alert('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚è¨±å¯ã—ã¦ãã ã•ã„ã€‚'); return; }
    const css = `
      :root{--text:#111;--border:#e5e7eb}
      body{font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Noto Sans JP,Meiryo,sans-serif;color:var(--text);margin:0;background:#fff}
      .wrap-n{max-width:1100px;margin:24px auto;padding:0 16px}
      h2{margin:0 0 12px;color:#0b1225}
      table.pretty{width:100%;border-collapse:collapse;border:1px solid var(--border)}
      table.pretty th,table.pretty td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
      thead th{background:#f8fafc}
      .b{display:inline-block;padding:2px 8px;border-radius:999px;font-weight:700;font-size:12px;border:1px solid #ddd}
      .b.yes{background:#ecfdf5;color:#065f46;border-color:#bbf7d0}
      .b.no{background:#fff1f2;color:#9f1239;border-color:#fecdd3}
      button{padding:8px 12px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer}
      @media print{#printBtn{display:none}}
    `;
    const build = () => {
      const doc = win.document;
      doc.title = 'ã¡ã„ã‹ã‚ ä¸€è¦§';
      const style = doc.createElement('style'); style.textContent = css; doc.head.appendChild(style);
      const wrap = doc.createElement('div'); wrap.className = 'wrap-n'; doc.body.appendChild(wrap);
      const h2 = doc.createElement('h2'); h2.textContent = 'ã¡ã„ã‹ã‚ ã”å½“åœ°ã‚­ãƒ¼ãƒ›ãƒ«ãƒ€ãƒ¼ ä¸€è¦§'; wrap.appendChild(h2);
      const table = doc.createElement('table'); table.className='pretty';
      const thead = doc.createElement('thead'); const trh = doc.createElement('tr');
      ['åœ°åŸŸ','éƒ½é“åºœçœŒ','åç§°','æ‰€æŒ','æ‰€æŒæ—¥'].forEach(t=>{const th=doc.createElement('th'); th.textContent=t; trh.appendChild(th);});
      thead.appendChild(trh); table.appendChild(thead);
      const tbody = doc.createElement('tbody');
      if(data.length===0){
        const tr=doc.createElement('tr'); const td=doc.createElement('td'); td.colSpan=5; td.textContent='ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'; tr.appendChild(td); tbody.appendChild(tr);
      }else{
        data.forEach(x=>{
          const tr=doc.createElement('tr');
          const td1=doc.createElement('td'); td1.textContent=x.region;
          const td2=doc.createElement('td'); td2.textContent=x.pref;
          const td3=doc.createElement('td'); td3.textContent=x.name;
          const td4=doc.createElement('td'); td4.style.textAlign='center'; const badge=doc.createElement('span'); badge.className='b '+(x.owned?'yes':'no'); badge.textContent=x.owned?'æ‰€æŒ':'æœªæ‰€æŒ'; td4.appendChild(badge);
          const td5=doc.createElement('td'); td5.textContent=x.ownedAt||'';
          tr.append(td1,td2,td3,td4,td5); tbody.appendChild(tr);
        });
      }
      table.appendChild(tbody); wrap.appendChild(table);
      const btnBox = doc.createElement('div'); btnBox.style.textAlign='right'; btnBox.style.marginTop='10px';
      const printBtn = doc.createElement('button'); printBtn.id='printBtn'; printBtn.textContent='ğŸ–¨ï¸ å°åˆ·'; printBtn.addEventListener('click', ()=>win.print());
      btnBox.appendChild(printBtn); wrap.appendChild(btnBox);
    };
    if (win.document.readyState === 'complete') build(); else win.addEventListener('load', build);
  }

  btnPrint.addEventListener('click', openPrintAll);
  btnCSVAll.addEventListener('click', ()=>exportCSV(items,'chiikawa_all.csv'));

  /* ===== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º ===== */
  function setStatus(t,cls=''){ syncStatus.textContent=t; syncStatus.className='small '+cls; }

  /* ===== Firestore åŒæœŸï¼ˆå®¶æ—ã‚³ãƒ¼ãƒ‰ä»˜ãï¼‰ ===== */
  const savedFamily = localStorage.getItem(FAMILY_KEY)||'';
  if(savedFamily) familyCodeInput.value = savedFamily;

  function ensureLoggedIn(){
    if(!fb.auth.currentUser){
      alert('ã¾ãš Google ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
      return false;
    }
    return true;
  }

  function showError(prefix, e){
    console.error(prefix, e);
    const msg = (e && (e.code || e.message)) ? ` (${e.code || e.message})` : '';
    setStatus(`ã‚¨ãƒ©ãƒ¼${msg}`, 'warn');
  }

  function connect(){
    if(!ensureLoggedIn()) return;
    const code=(familyCodeInput.value||'').trim();
    if(!code) return alert('å®¶æ—ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
    setStatus('æ¥ç¶šä¸­â€¦');
    localStorage.setItem(FAMILY_KEY, code);

    fb.docRef = doc(fb.db,'families', code,'lists','default');

    // åˆå›èª­ã¿è¾¼ã¿
    getDoc(fb.docRef).then(async (snap)=>{
      if(snap.exists()){
        fb.applying=true;
        const remote=(snap.data().items||[]).map(normalize);
        items = mergeItems(remote, items);
        save();
        fb.applying=false;
        render();
      }else{
        await setDoc(fb.docRef,{items, updatedAt: Date.now()});
      }
      // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è³¼èª­
      if(fb.unsub) fb.unsub();
      fb.unsub = onSnapshot(fb.docRef, s=>{
        if(!s.exists()) return;
        const remote=(s.data().items||[]).map(normalize);
        fb.applying=true; items = mergeItems(remote, items); save(); fb.applying=false; render();
      }, e=>showError('onSnapshotå¤±æ•—', e));

      fb.connected=true; setStatus('åŒæœŸä¸­','ok');
    }).catch(e=>showError('getDocå¤±æ•—', e));
  }

  function disconnect(){
    if(fb.unsub) fb.unsub();
    fb.unsub=null; fb.connected=false; fb.docRef=null; setStatus('æœªæ¥ç¶š');
  }

  connectBtn.addEventListener('click', connect);
  disconnectBtn.addEventListener('click', disconnect);

  let pushTimer=null;
  function pushToCloudDebounced(){ if(pushTimer) clearTimeout(pushTimer); pushTimer=setTimeout(()=>{ if(fb.docRef) setDoc(fb.docRef,{items, updatedAt: Date.now()}); },300); }

  function mergeItems(remote, local){
    const map=new Map();
    for(const it of local){ map.set(it.region+'__'+it.pref+'__'+it.name, it); }
    for(const it of remote){
      const k=it.region+'__'+it.pref+'__'+it.name;
      if(!map.has(k)) map.set(k, it);
      else{
        const a=map.get(k);
        map.set(k,{...a,...it,owned:!!(a.owned||it.owned),ownedAt:a.ownedAt||it.ownedAt||null});
      }
    }
    return [...map.values()].map(normalize);
  }

  /* ===== ç”»é¢æç”» ===== */
  function card(it){
    const d=document.createElement('div'); d.className='card';
    const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=!!it.owned;
    cb.addEventListener('change',()=>{it.owned=cb.checked;if(cb.checked&&!it.ownedAt)it.ownedAt=today();if(!cb.checked)it.ownedAt=null;save();render()});
    const name=document.createElement('span'); name.textContent=it.name;
    const dd=document.createElement('span'); dd.className='small'; dd.textContent=it.ownedAt?`(${it.ownedAt})`:'';
    d.appendChild(cb); d.appendChild(name); d.appendChild(dd); return d;
  }

  function render(){
    app.innerHTML='';
    const frag=document.createDocumentFragment();
    const regions=[...new Set(items.map(it=>it.region))].sort((a,b)=>(REGION_ORDER.indexOf(a)+1||999)-(REGION_ORDER.indexOf(b)+1||999)||a.localeCompare(b,'ja'));
    for(const r of regions){
      const rItems=items.filter(it=>it.region===r);
      const ownR=rItems.filter(x=>x.owned).length;
      const details=document.createElement('details'); details.className='region'; details.open=(localStorage.getItem(LS_KEY+'_open_'+r)==='1');
      const summary=document.createElement('summary'); summary.textContent=`${r} ${ownR}/${rItems.length}`; details.appendChild(summary);
      const inner=document.createElement('div'); inner.className='inner';
      const byPref={}; for(const it of rItems){(byPref[it.pref]||(byPref[it.pref]=[])).push(it)}
      const prefNames=Object.keys(byPref).sort((a,b)=>a.localeCompare(b,'ja'));
      for(const p of prefNames){
        const sec=document.createElement('section'); sec.className='panel';
        const h2=document.createElement('h2'); const cnt=byPref[p].length; const own=byPref[p].filter(x=>x.owned).length; h2.textContent=`${p} ${own}/${cnt}`; sec.appendChild(h2);
        byPref[p].sort((a,b)=>(a.name||'').localeCompare(b.name||'','ja')).forEach(it=>sec.appendChild(card(it)));
        inner.appendChild(sec);
      }
      details.appendChild(inner);
      details.addEventListener('toggle',()=>localStorage.setItem(LS_KEY+'_open_'+r,details.open?'1':'0'));
      frag.appendChild(details);
    }
    app.appendChild(frag);
    const ownTotal=items.filter(x=>x.owned).length;
    document.getElementById('stats').textContent = `${ownTotal}/${items.length} æ‰€æŒ (${items.length?Math.round(ownTotal/items.length*100):0}%)`;
  }

  // åˆæœŸæç”»
  render();
})(); // IIFE
</script>
</body>
</html>
