<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã¡ã„ã‹ã‚ ã”å½“åœ°ã‚­ãƒ¼ãƒ›ãƒ«ãƒ€ãƒ¼ æ‰€æŒãƒã‚§ãƒƒã‚¯ï¼ˆå®¶æ—å…±æœ‰ãƒ»Googleãƒ­ã‚°ã‚¤ãƒ³ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#0f172a;--panel:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#22d3ee;--accent2:#a78bfa;--ok:#34d399}
    body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Noto Sans JP,Meiryo,sans-serif;background:#0b1225;color:var(--text)}
    header{position:sticky;top:0;background:#0f172a;z-index:10;border-bottom:1px solid #1f2937}
    .wrap{max-width:1100px;margin:auto;padding:12px}
    h1{margin:0 0 8px}
    input,select,button,textarea{margin:4px;padding:8px;border-radius:8px;border:1px solid #2b3a5d;background:#0b1327;color:var(--text)}
    button{cursor:pointer;background:linear-gradient(135deg,var(--accent2),var(--accent));border:none}
    .ghost{background:transparent;border:1px solid #2b3a5d}
    .small{font-size:12px;color:#94a3b8}
    details.region{margin:12px 0;border:1px solid #2b3a5d;border-radius:8px;overflow:hidden}
    details.region>summary{list-style:none;cursor:pointer;padding:10px 12px;background:#0b1327;font-weight:700;color:var(--accent)}
    details.region>summary::-webkit-details-marker{display:none}
    details.region .inner{padding:8px 12px;background:#0f172a}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .ok{color:#10b981}
    .warn{color:#f59e0b}
    .hide{display:none}
    /* ---- compact table view ---- */
    .tableWrap{margin:8px 0}
    .tbl{width:100%;border-collapse:collapse;border:1px solid #1f2937;background:#0b1327}
    .tbl th,.tbl td{padding:8px 10px;border-bottom:1px solid #1f2937;text-align:left}
    .tbl thead th{background:#0f172a;color:var(--muted);font-weight:600}
    .tbl tr:hover{background:#0e1832}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-weight:700;font-size:12px;border:1px solid #2b3a5d;margin-left:8px}
    .badge.yes{border-color:#065f46;color:#10b981;background:rgba(16,185,129,.08)}
    .small-muted{font-size:12px;color:#94a3b8;margin-left:8px}
  </style>
</head>
<body>
<header class="wrap">
  <h1>ã¡ã„ã‹ã‚ ã”å½“åœ°ã‚­ãƒ¼ãƒ›ãƒ«ãƒ€ãƒ¼ æ‰€æŒãƒã‚§ãƒƒã‚¯</h1>
  <div id="stats" class="small"></div>

  <div class="wrap row" style="margin-bottom:6px">
    <button id="btnPrint">ä¸€è¦§ã‚’è¡¨ç¤º/å°åˆ·</button>
    <button id="btnCSVAll">CSV (å…¨ä»¶)</button>
    <span class="small" style="opacity:.85">åœ°åŸŸâ†’éƒ½é“åºœçœŒâ†’åç§°ã§å‡ºåŠ›</span>
  </div>

  <!-- èªè¨¼UI -->
  <div class="wrap row" id="authRow">
    <button id="loginBtn" class="ghost">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
    <button id="logoutBtn" class="ghost hide">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    <span id="userInfo" class="small"></span>
  </div>

  <!-- å®¶æ—ã‚³ãƒ¼ãƒ‰ï¼‹åŒæœŸUI -->
  <div class="wrap row" style="margin-top:6px">
    <input id="familyCode" placeholder="å®¶æ—ã‚³ãƒ¼ãƒ‰ï¼ˆä¾‹: my-familyï¼‰" style="min-width:220px">
    <button id="connectBtn" class="ghost">åŒæœŸã‚ªãƒ³</button>
    <button id="disconnectBtn" class="ghost">åŒæœŸã‚ªãƒ•</button>
    <span id="syncStatus" class="small">æœªæ¥ç¶š</span>
  </div>
</header>

<main class="wrap" id="app"></main>

<!-- Firebase SDK ã‚’ ES Modules ã§èª­ã¿è¾¼ã¿ï¼ˆv10ç³»ï¼‰ -->
<script type="module">
/* ===== éƒ½é“åºœçœŒé †ã®å®šç¾© ===== */
const PREF_ORDER = [
  "åŒ—æµ·é“","é’æ£®","å²©æ‰‹","å®®åŸ","ç§‹ç”°","å±±å½¢","ç¦å³¶",
  "èŒ¨åŸ","æ ƒæœ¨","ç¾¤é¦¬","åŸ¼ç‰","åƒè‘‰","æ±äº¬","ç¥å¥ˆå·",
  "æ–°æ½Ÿ","å¯Œå±±","çŸ³å·","ç¦äº•","å±±æ¢¨","é•·é‡","å²é˜œ","é™å²¡","æ„›çŸ¥",
  "ä¸‰é‡","æ»‹è³€","äº¬éƒ½","å¤§é˜ª","å…µåº«","å¥ˆè‰¯","å’Œæ­Œå±±",
  "é³¥å–","å³¶æ ¹","å²¡å±±","åºƒå³¶","å±±å£",
  "å¾³å³¶","é¦™å·","æ„›åª›","é«˜çŸ¥",
  "ç¦å²¡","ä½è³€","é•·å´","ç†Šæœ¬","å¤§åˆ†","å®®å´","é¹¿å…å³¶","æ²–ç¸„"
];
const prefRank = (p)=>{const ix=PREF_ORDER.indexOf(p);return ix>=0?ix:999;};

/* ===== Firebase import ===== */
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js';
import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js';
import { getFirestore, doc, onSnapshot, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js';

(()=>{
  /* ===== å›ºå®šFirebaseè¨­å®š ===== */
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyC66I66AmKfZFIyIKX_TXBSRTIsR2IDEDE",
    authDomain: "chiikawa-gotouchi-project.firebaseapp.com",
    projectId: "chiikawa-gotouchi-project",
    storageBucket: "chiikawa-gotouchi-project.appspot.com",
    messagingSenderId: "602616418153",
    appId: "1:602616418153:web:e73e4de1bf4942ee16b7f8"
  };

  /* ===== ã‚¢ãƒ—ãƒªå†…çŠ¶æ…‹ ===== */
  const LS_KEY='chiikawa-keyholders-v11';
  const FAMILY_KEY=LS_KEY+'__family';
  // ã€Œæ²–ç¸„åœ°æ–¹ã€ã¯ä½¿ã‚ãªã„ï¼ˆä¹å·åœ°æ–¹ã«çµ±ä¸€ï¼‰
  const REGION_ORDER=[
    "åŒ—æµ·é“åœ°æ–¹","æ±åŒ—åœ°æ–¹","é–¢æ±åœ°æ–¹","ä¸­éƒ¨åœ°æ–¹","è¿‘ç•¿åœ°æ–¹",
    "ä¸­å›½åœ°æ–¹","å››å›½åœ°æ–¹","ä¹å·åœ°æ–¹","æµ·å¤–","ãã®ä»–"
  ];

  // ---- ãƒ‡ãƒ¼ã‚¿ï¼ˆæ²–ç¸„ã¯ä¹å·åœ°æ–¹ã¸ï¼‰----
  const FULL=[
    {region:"åŒ—æµ·é“åœ°æ–¹",pref:"åŒ—æµ·é“",name:"åŒ—æµ·é“"},
    {region:"åŒ—æµ·é“åœ°æ–¹",pref:"åŒ—æµ·é“",name:"ãƒ©ãƒ™ãƒ³ãƒ€ãƒ¼"},
    {region:"åŒ—æµ·é“åœ°æ–¹",pref:"åŒ—æµ·é“",name:"ãƒ¡ãƒ­ãƒ³"},
    {region:"åŒ—æµ·é“åœ°æ–¹",pref:"åŒ—æµ·é“",name:"ã‚·ãƒã‚¨ãƒŠã‚¬"},
    {region:"åŒ—æµ·é“åœ°æ–¹",pref:"åŒ—æµ·é“",name:"ãã¾"},
    {region:"åŒ—æµ·é“åœ°æ–¹",pref:"åŒ—æµ·é“",name:"æœ­å¹Œãƒ†ãƒ¬ãƒ“å¡”"},
    {region:"åŒ—æµ·é“åœ°æ–¹",pref:"åŒ—æµ·é“",name:"å‡½é¤¨ã®å¤œæ™¯"},
    {region:"æ±åŒ—åœ°æ–¹",pref:"é’æ£®",name:"ã­ã¶ãŸç¥­"},
    {region:"æ±åŒ—åœ°æ–¹",pref:"é’æ£®",name:"ã‚Šã‚“ã”"},
    {region:"æ±åŒ—åœ°æ–¹",pref:"å²©æ‰‹",name:"ã‚ã‚“ã“ãã°"},
    {region:"æ±åŒ—åœ°æ–¹",pref:"å²©æ‰‹",name:"éŠ€æ²³é‰„é“"},
    {region:"æ±åŒ—åœ°æ–¹",pref:"å®®åŸ",name:"ç¬¹ã‹ã¾"},
    {region:"æ±åŒ—åœ°æ–¹",pref:"å®®åŸ",name:"ä¼Šé”æ”¿å®—"},
    {region:"æ±åŒ—åœ°æ–¹",pref:"å®®åŸ",name:"ã“ã‘ã—"},
    {region:"æ±åŒ—åœ°æ–¹",pref:"ç§‹ç”°",name:"ç§‹ç”°çŠ¬"},
    {region:"æ±åŒ—åœ°æ–¹",pref:"ç§‹ç”°",name:"ãªã¾ã¯ã’"},
    {region:"æ±åŒ—åœ°æ–¹",pref:"å±±å½¢",name:"ã•ãã‚‰ã‚“ã¼"},
    {region:"æ±åŒ—åœ°æ–¹",pref:"å±±å½¢",name:"ç±³æ²¢ç‰›"},
    {region:"æ±åŒ—åœ°æ–¹",pref:"å±±å½¢",name:"èŠ±ç¬ "},
    {region:"æ±åŒ—åœ°æ–¹",pref:"å±±å½¢",name:"ã ã ã¡ã‚ƒè±†"},
    {region:"æ±åŒ—åœ°æ–¹",pref:"ç¦å³¶",name:"èµ¤ã¹ã“"},
    {region:"æ±åŒ—åœ°æ–¹",pref:"ç¦å³¶",name:"ãƒãƒ¯ã‚¤ã‚¢ãƒ³"},
    {region:"æ±åŒ—åœ°æ–¹",pref:"ç¦å³¶",name:"ç™½è™éšŠ"},
    {region:"æ±åŒ—åœ°æ–¹",pref:"ç¦å³¶",name:"æ¡ƒ"},
    {region:"é–¢æ±åœ°æ–¹",pref:"èŒ¨åŸ",name:"é»„é–€æ§˜"},
    {region:"é–¢æ±åœ°æ–¹",pref:"èŒ¨åŸ",name:"æ°´æˆ¸ç´è±†"},
    {region:"é–¢æ±åœ°æ–¹",pref:"æ ƒæœ¨",name:"ã‚¹ã‚«ã‚¤ãƒ™ãƒªãƒ¼"},
    {region:"é–¢æ±åœ°æ–¹",pref:"æ ƒæœ¨",name:"è—¤ã®èŠ±"},
    {region:"é–¢æ±åœ°æ–¹",pref:"æ ƒæœ¨",name:"ä¸‰çŒ¿"},
    {region:"é–¢æ±åœ°æ–¹",pref:"æ ƒæœ¨",name:"é–¢æ±ãƒ»æ ƒæœ¨ãƒ¬ãƒ¢ãƒ³"},
    {region:"é–¢æ±åœ°æ–¹",pref:"ç¾¤é¦¬",name:"è‰æ´¥æ¸©æ³‰"},
    {region:"é–¢æ±åœ°æ–¹",pref:"ç¾¤é¦¬",name:"ã ã‚‹ã¾"},
    {region:"é–¢æ±åœ°æ–¹",pref:"ç¾¤é¦¬",name:"ç„¼ãã¾ã‚“ã˜ã‚…ã†"},
    {region:"é–¢æ±åœ°æ–¹",pref:"åŸ¼ç‰",name:"ã•ã¤ã¾ã„ã‚‚"},
    {region:"é–¢æ±åœ°æ–¹",pref:"åŸ¼ç‰",name:"æ·±è°·ãƒã‚®"},
    {region:"é–¢æ±åœ°æ–¹",pref:"åƒè‘‰",name:"è½èŠ±ç”Ÿ"},
    {region:"é–¢æ±åœ°æ–¹",pref:"æ±äº¬",name:"é›·é–€"},
    {region:"é–¢æ±åœ°æ–¹",pref:"æ±äº¬",name:"æ±äº¬ãƒ‘ãƒ³ãƒ€"},
    {region:"é–¢æ±åœ°æ–¹",pref:"æ±äº¬",name:"æ±äº¬ã‚¿ãƒ¯ãƒ¼"},
    {region:"é–¢æ±åœ°æ–¹",pref:"æ±äº¬",name:"ã‚¹ã‚«ã‚¤ãƒ„ãƒªãƒ¼"},
    {region:"é–¢æ±åœ°æ–¹",pref:"æ±äº¬",name:"æ±äº¬é§…ä¸¸ã®å†…é§…èˆ"},
    {region:"é–¢æ±åœ°æ–¹",pref:"ç¥å¥ˆå·",name:"ç®±æ ¹æ¸©æ³‰ã¾ã‚“ã˜ã‚…ã†"},
    {region:"é–¢æ±åœ°æ–¹",pref:"ç¥å¥ˆå·",name:"æ¨ªæµœé‡‘ã®è±š"},
    {region:"é–¢æ±åœ°æ–¹",pref:"ç¥å¥ˆå·",name:"éŒå€‰å¤§ä»ã•ã¾"},
    {region:"é–¢æ±åœ°æ–¹",pref:"ç¥å¥ˆå·",name:"å¯„æœ¨ç´°å·¥"},
    {region:"é–¢æ±åœ°æ–¹",pref:"ç¥å¥ˆå·",name:"æ¨ªæµœã‚«ãƒ³ãƒ•ãƒ¼"},
    {region:"é–¢æ±åœ°æ–¹",pref:"ç¥å¥ˆå·",name:"å¤§æ¶Œè°·é»’ãŸã¾ã”"},
    {region:"ä¸­éƒ¨åœ°æ–¹",pref:"æ–°æ½Ÿ",name:"ç¬¹å›£å­"},
    {region:"ä¸­éƒ¨åœ°æ–¹",pref:"æ–°æ½Ÿ",name:"ãƒˆã‚­"},
    {region:"ä¸­éƒ¨åœ°æ–¹",pref:"å¯Œå±±",name:"ãƒ›ã‚¿ãƒ«ã‚¤ã‚«"},
    {region:"ä¸­éƒ¨åœ°æ–¹",pref:"çŸ³å·",name:"å…¼å…­åœ’"},
    {region:"ä¸­éƒ¨åœ°æ–¹",pref:"ç¦äº•",name:"æç«œ"},
    {region:"ä¸­éƒ¨åœ°æ–¹",pref:"å±±æ¢¨",name:"ã¶ã©ã†"},
    {region:"ä¸­éƒ¨åœ°æ–¹",pref:"é•·é‡",name:"ä¿¡å·ã‚Šã‚“ã”"},
    {region:"ä¸­éƒ¨åœ°æ–¹",pref:"é•·é‡",name:"ä¿¡å·ã‚ªã‚³ã‚¸ãƒ§"},
    {region:"ä¸­éƒ¨åœ°æ–¹",pref:"å²é˜œ",name:"åˆæŒé€ ã‚Š"},
    {region:"ä¸­éƒ¨åœ°æ–¹",pref:"å²é˜œ",name:"ã•ã‚‹ã¼ã¼"},
    {region:"ä¸­éƒ¨åœ°æ–¹",pref:"é™å²¡",name:"ãŠèŒ¶"},
    {region:"ä¸­éƒ¨åœ°æ–¹",pref:"é™å²¡",name:"ã¿ã‹ã‚“"},
    {region:"ä¸­éƒ¨åœ°æ–¹",pref:"é™å²¡",name:"ã†ãªã"},
    {region:"ä¸­éƒ¨åœ°æ–¹",pref:"é™å²¡",name:"ã„ã¡ã”"},
    {region:"ä¸­éƒ¨åœ°æ–¹",pref:"é™å²¡",name:"æ¬¡éƒé•·"},
    {region:"ä¸­éƒ¨åœ°æ–¹",pref:"é™å²¡",name:"æ¡œãˆã³"},
    {region:"ä¸­éƒ¨åœ°æ–¹",pref:"å¯Œå£«å±±",name:"å¯Œå£«å±±"},
    {region:"ä¸­éƒ¨åœ°æ–¹",pref:"æ„›çŸ¥",name:"ã—ã‚ƒã¡ã»ã“"},
    {region:"ä¸­éƒ¨åœ°æ–¹",pref:"æ„›çŸ¥",name:"å°å€‰ãƒˆãƒ¼ã‚¹ãƒˆ"},
    {region:"è¿‘ç•¿åœ°æ–¹",pref:"ä¸‰é‡",name:"çœŸç "},
    {region:"è¿‘ç•¿åœ°æ–¹",pref:"ä¸‰é‡",name:"ä¼Šå‹¢ã‚¨ãƒ“"},
    {region:"è¿‘ç•¿åœ°æ–¹",pref:"æ»‹è³€",name:"çµç¶æ¹–"},
    {region:"è¿‘ç•¿åœ°æ–¹",pref:"æ»‹è³€",name:"å½¦æ ¹åŸ"},
    {region:"è¿‘ç•¿åœ°æ–¹",pref:"æ»‹è³€",name:"å¿è€…"},
    {region:"è¿‘ç•¿åœ°æ–¹",pref:"æ»‹è³€",name:"ä¿¡æ¥½ãŸã¬ã"},
    {region:"è¿‘ç•¿åœ°æ–¹",pref:"äº¬éƒ½",name:"å…«ãƒƒæ©‹"},
    {region:"è¿‘ç•¿åœ°æ–¹",pref:"äº¬éƒ½",name:"æ–°é¸çµ„"},
    {region:"è¿‘ç•¿åœ°æ–¹",pref:"äº¬éƒ½",name:"ä¼è¦‹ç¨²è·"},
    {region:"è¿‘ç•¿åœ°æ–¹",pref:"äº¬éƒ½",name:"æŠ¹èŒ¶ã‚½ãƒ•ãƒˆ"},
    {region:"è¿‘ç•¿åœ°æ–¹",pref:"äº¬éƒ½",name:"é‡‘é–£å¯º"},
    {region:"è¿‘ç•¿åœ°æ–¹",pref:"äº¬éƒ½",name:"ãƒ‹ãƒ‡ãƒƒã‚¯äº¬éƒ½ã‚¿ãƒ¯ãƒ¼"},
    {region:"è¿‘ç•¿åœ°æ–¹",pref:"å¤§é˜ª",name:"ãŸã“ç„¼"},
    {region:"è¿‘ç•¿åœ°æ–¹",pref:"å¤§é˜ª",name:"é€šå¤©é–£"},
    {region:"è¿‘ç•¿åœ°æ–¹",pref:"å¤§é˜ª",name:"å¤§é˜ªã®ãŠã°ã¡ã‚ƒã‚“"},
    {region:"è¿‘ç•¿åœ°æ–¹",pref:"å¤§é˜ª",name:"å¤§é˜ªåŸ"},
    {region:"è¿‘ç•¿åœ°æ–¹",pref:"å¤§é˜ª",name:"ãƒŸãƒƒã‚¯ã‚¹ã‚¸ãƒ¥ãƒ¼ã‚¹"},
    {region:"è¿‘ç•¿åœ°æ–¹",pref:"å…µåº«",name:"ç¥æˆ¸ã‚»ãƒ¼ãƒ©ãƒ¼"},
    {region:"è¿‘ç•¿åœ°æ–¹",pref:"å…µåº«",name:"ç¥æˆ¸ä¸­è¯è¡—"},
    {region:"è¿‘ç•¿åœ°æ–¹",pref:"å…µåº«",name:"æ·¡è·¯ç‰ã­ã"},
    {region:"è¿‘ç•¿åœ°æ–¹",pref:"å…µåº«",name:"ç¥æˆ¸ãƒãƒ¼ãƒˆã‚¿ãƒ¯ãƒ¼"},
    {region:"è¿‘ç•¿åœ°æ–¹",pref:"å…µåº«",name:"å§«è·¯åƒå§«"},
    {region:"è¿‘ç•¿åœ°æ–¹",pref:"å…µåº«",name:"ã‚³ã‚¦ãƒãƒˆãƒª"},
    {region:"è¿‘ç•¿åœ°æ–¹",pref:"å¥ˆè‰¯",name:"é¹¿"},
    {region:"è¿‘ç•¿åœ°æ–¹",pref:"å¥ˆè‰¯",name:"å¤§ä»"},
    {region:"è¿‘ç•¿åœ°æ–¹",pref:"å’Œæ­Œå±±",name:"ãƒ‘ãƒ³ãƒ€"},
    {region:"è¿‘ç•¿åœ°æ–¹",pref:"å’Œæ­Œå±±",name:"ã¿ã‹ã‚“"},
    {region:"å››å›½åœ°æ–¹",pref:"é³´é–€",name:"æ¸¦æ½®"},
    {region:"å››å›½åœ°æ–¹",pref:"é¦™å·",name:"ã•ã¬ãã†ã©ã‚“"},
    {region:"å››å›½åœ°æ–¹",pref:"æ„›åª›",name:"ã¿ã‹ã‚“"},
    {region:"å››å›½åœ°æ–¹",pref:"é«˜çŸ¥",name:"å‚æœ¬é¾é¦¬"},
    {region:"ä¸­å›½åœ°æ–¹",pref:"ç€¬æˆ¸å†…",name:"ç€¬æˆ¸å†…ãƒ¬ãƒ¢ãƒ³"},
    {region:"ä¸­å›½åœ°æ–¹",pref:"å³¶æ ¹",name:"ç¸çµã³"},
    {region:"ä¸­å›½åœ°æ–¹",pref:"å²¡å±±",name:"æ¡ƒå¤ªéƒ"},
    {region:"ä¸­å›½åœ°æ–¹",pref:"å²¡å±±",name:"æ¡ƒã‹ã‚‰ç”Ÿã¾ã‚ŒãŸæ¡ƒå¤ªéƒ"},
    {region:"ä¸­å›½åœ°æ–¹",pref:"åºƒå³¶",name:"ã‚‚ã¿ã˜é¥…é ­"},
    {region:"ä¸­å›½åœ°æ–¹",pref:"åºƒå³¶",name:"å®®å³¶ã®é¹¿"},
    {region:"ä¸­å›½åœ°æ–¹",pref:"åºƒå³¶",name:"å°¾é“ãƒ©ãƒ¼ãƒ¡ãƒ³"},
    {region:"ä¸­å›½åœ°æ–¹",pref:"åºƒå³¶",name:"ãŠå¥½ã¿ç„¼"},
    {region:"ä¸­å›½åœ°æ–¹",pref:"å®®å³¶",name:"ã—ã‚ƒã‚‚ã˜"},
    {region:"ä¸­å›½åœ°æ–¹",pref:"å±±å£",name:"ãµã"},
    {region:"ä¸­å›½åœ°æ–¹",pref:"å±±é™°",name:"ã„ãªã°ã®ç™½ã†ã•ã"},
    {region:"ä¹å·åœ°æ–¹",pref:"ç¦å²¡",name:"ã‚ã¾ãŠã†"},
    {region:"ä¹å·åœ°æ–¹",pref:"ç¦å²¡",name:"æ˜å¤ªå­"},
    {region:"ä¹å·åœ°æ–¹",pref:"ç¦å²¡",name:"ã¨ã‚“ã“ã¤ãƒ©ãƒ¼ãƒ¡ãƒ³"},
    {region:"ä¹å·åœ°æ–¹",pref:"ç¦å²¡",name:"åŒ—ä¹å·ãƒãƒŠãƒŠã®å©ãå£²ã‚Š"},
    {region:"ä¹å·åœ°æ–¹",pref:"ç¦å²¡",name:"ã«ã‚ã‹"},
    {region:"ä¹å·åœ°æ–¹",pref:"ä½è³€",name:"ãƒãƒ«ãƒ¼ãƒ³"},
    {region:"ä¹å·åœ°æ–¹",pref:"é•·å´",name:"ã‚«ã‚¹ãƒ†ãƒ©"},
    {region:"ä¹å·åœ°æ–¹",pref:"ç†Šæœ¬",name:"ç†Šæœ¬åŸ"},
    {region:"ä¹å·åœ°æ–¹",pref:"ç†Šæœ¬",name:"è¾›å­ã‚Œã‚“ã“ã‚“"},
    {region:"ä¹å·åœ°æ–¹",pref:"ç†Šæœ¬",name:"ã™ã„ã‹"},
    {region:"ä¹å·åœ°æ–¹",pref:"å®®å´",name:"ãƒãƒ³ã‚´ãƒ¼"},
    {region:"ä¹å·åœ°æ–¹",pref:"å®®å´",name:"ã‚µãƒ¼ãƒ•ã‚£ãƒ³"},
    {region:"ä¹å·åœ°æ–¹",pref:"å¤§åˆ†",name:"æ¸©æ³‰"},
    {region:"ä¹å·åœ°æ–¹",pref:"é¹¿å…å³¶",name:"é»’è±š"},
    {region:"ä¹å·åœ°æ–¹",pref:"é¹¿å…å³¶",name:"æ¡œå³¶"},
    {region:"ä¹å·åœ°æ–¹",pref:"é¹¿å…å³¶",name:"æ°·ã—ã‚ãã¾"},
    {region:"ä¹å·åœ°æ–¹",pref:"æ²–ç¸„",name:"ã‚·ãƒ¼ã‚µãƒ¼"},
    {region:"ä¹å·åœ°æ–¹",pref:"æ²–ç¸„",name:"ã‚¸ãƒ³ãƒ™ã‚¨ã‚¶ãƒ¡"},
    {region:"ä¹å·åœ°æ–¹",pref:"æ²–ç¸„",name:"ç´…ã„ã‚‚ã‚¿ãƒ«ãƒˆ"},
    {region:"ä¹å·åœ°æ–¹",pref:"å¥„ç¾",name:"ã‚¢ãƒãƒŸãƒã‚¯ãƒ­ã‚¦ã‚µã‚®"},
    {region:"ãã®ä»–",pref:"æ¸©æ³‰åœ°",name:"æ¸©æ³‰"},
    {region:"ãã®ä»–",pref:"ãƒªã‚¾ãƒ¼ãƒˆ",name:"ã‚¹ã‚­ãƒ¼å†¬å­£é™å®š"},
    {region:"ãã®ä»–",pref:"ãƒªã‚¾ãƒ¼ãƒˆ",name:"ã‚¹ãƒãƒœãƒ¼å†¬å­£é™å®š"},
    {region:"ãã®ä»–",pref:"JRæ±æ—¥æœ¬",name:"ã¯ã‚„ã¶ã•"},
    {region:"ãã®ä»–",pref:"JRæ±æ—¥æœ¬",name:"E7"},
    {region:"ãã®ä»–",pref:"JRæ±æµ·ãƒ»è¥¿æ—¥æœ¬",name:"N700S"},
    {region:"ãã®ä»–",pref:"JRæ±æµ·ãƒ»è¥¿æ—¥æœ¬",name:"Dr.Yellow"},
    {region:"ãã®ä»–",pref:"ç©ºæ¸¯",name:"ãƒ‘ã‚¤ãƒ­ãƒƒãƒˆ"},
    {region:"æµ·å¤–",pref:"ãƒã‚«ã‚ª",name:"ã‚»ãƒ³ãƒˆãƒãƒ¼ãƒ«"},
    {region:"æµ·å¤–",pref:"ãƒã‚«ã‚ª",name:"ã‚¨ãƒƒã‚°ã‚¿ãƒ«ãƒˆ"},
    {region:"æµ·å¤–",pref:"ãƒã‚«ã‚ª",name:"ã‚¢ã‚ºãƒ¬ãƒ¼ã‚¸ãƒ§"},
    {region:"æµ·å¤–",pref:"é¦™æ¸¯",name:"ã‚¨ãƒƒã‚°ãƒ¯ãƒƒãƒ•ãƒ«"},
    {region:"æµ·å¤–",pref:"é¦™æ¸¯",name:"ãƒ“ã‚¯ãƒˆãƒªã‚¢ãƒãƒ¼ãƒãƒ¼"},
    {region:"æµ·å¤–",pref:"é¦™æ¸¯",name:"ã‚«ãƒ³ãƒ•ãƒ¼"},
    {region:"æµ·å¤–",pref:"ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢",name:"ã‚³ã‚¢ãƒ©"},
    {region:"æµ·å¤–",pref:"ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢",name:"ã‚«ãƒ³ã‚¬ãƒ«ãƒ¼"}
  ];

  // --- æ—§ãƒ‡ãƒ¼ã‚¿ã«ã€Œæ²–ç¸„åœ°æ–¹ã€ãŒæ®‹ã£ã¦ã„ã¦ã‚‚ä¹å·åœ°æ–¹ã¸ãƒãƒƒãƒ—ã™ã‚‹ ---
  function migrateRegion(v){ return v==="æ²–ç¸„åœ°æ–¹" ? "ä¹å·åœ°æ–¹" : v; }

  function today(){const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
  function normalize(x){
    return{
      region:migrateRegion(String(x.region||'')),
      pref:String(x.pref||''),
      name:String(x.name||''),
      owned:!!x.owned,
      ownedAt:x.ownedAt||null
    };
  }
  function load(){try{const a=JSON.parse(localStorage.getItem(LS_KEY));if(Array.isArray(a))return a.map(normalize);return null}catch{return null}}
  let items=load()||FULL.map(x=>normalize(x));

  function setStatus(t,cls=''){ syncStatus.textContent=t; syncStatus.className='small '+(cls||''); }

  /* ===== UIè¦ç´  ===== */
  const app=document.getElementById('app');
  const btnPrint=document.getElementById('btnPrint');
  const btnCSVAll=document.getElementById('btnCSVAll');
  const familyCodeInput=document.getElementById('familyCode');
  const connectBtn=document.getElementById('connectBtn');
  const disconnectBtn=document.getElementById('disconnectBtn');
  const syncStatus=document.getElementById('syncStatus');
  const loginBtn=document.getElementById('loginBtn');
  const logoutBtn=document.getElementById('logoutBtn');
  const userInfo=document.getElementById('userInfo');

  /* ===== Firebase åˆæœŸåŒ–ãƒ»èªè¨¼ ===== */
  const fb={app:null,auth:null,db:null,docRef:null,unsub:null,connected:false,applying:false,uid:null};
  fb.app = initializeApp(FIREBASE_CONFIG);
  fb.auth = getAuth(fb.app);
  fb.db = getFirestore(fb.app);
  const provider = new GoogleAuthProvider();

  loginBtn.addEventListener('click', async () => {
    try{ await signInWithPopup(fb.auth, provider); }
    catch(e){ console.error('login error', e); setStatus('ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—','warn'); alert('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e.code || e.message)); }
  });
  logoutBtn.addEventListener('click', async () => {
    try{ await signOut(fb.auth); } catch(e){ console.error('logout error', e); }
  });

  // ---- Firestore åŒæœŸ ----
  function disconnect(){
    if(fb.unsub) fb.unsub();
    fb.unsub=null; fb.connected=false; fb.docRef=null; setStatus('æœªæ¥ç¶š');
  }
  function showError(prefix, e){
    console.error(prefix, e);
    const msg=(e && (e.code||e.message))?` (${e.code||e.message})`:'';
    setStatus(`ã‚¨ãƒ©ãƒ¼${msg}`,'warn');
  }
  function ensureLoggedIn(){
    if(!fb.auth.currentUser){ alert('ã¾ãš Google ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚'); return false; }
    return true;
  }
  function mergeItems(remote, local){
    // æ­£è¦åŒ–ï¼‹åœ°åŸŸç§»è¡Œã‚’ä¸¡æ–¹ã«é©ç”¨
    const map=new Map();
    for(const it of local.map(normalize)){
      map.set(it.region+'__'+it.pref+'__'+it.name, it);
    }
    for(const it0 of remote){
      const it=normalize(it0);
      const k=it.region+'__'+it.pref+'__'+it.name;
      if(!map.has(k)) map.set(k, it);
      else{
        const a=map.get(k);
        map.set(k,{...a,...it,owned:!!(a.owned||it.owned),ownedAt:a.ownedAt||it.ownedAt||null});
      }
    }
    return [...map.values()];
  }
  let pushTimer=null;
  function pushToCloudDebounced(){
    if(pushTimer) clearTimeout(pushTimer);
    pushTimer=setTimeout(()=>{ if(fb.docRef) setDoc(fb.docRef,{items, updatedAt: Date.now()}); },300);
  }
  function save(){
    localStorage.setItem(LS_KEY,JSON.stringify(items));
    if(fb.connected && !fb.applying) pushToCloudDebounced();
  }
  function connect(){
    if(!ensureLoggedIn()) return;
    const code=(familyCodeInput.value||'').trim();
    if(!code) return alert('å®¶æ—ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
    setStatus('æ¥ç¶šä¸­â€¦');
    localStorage.setItem(FAMILY_KEY, code);

    fb.docRef = doc(fb.db,'families', code,'lists','default');

    getDoc(fb.docRef).then(async (snap)=>{
      if(snap.exists()){
        fb.applying=true;
        const remote=(snap.data().items||[]).map(normalize);
        items = mergeItems(remote, items);
        save();
        fb.applying=false;
        render();
      }else{
        await setDoc(fb.docRef,{items, updatedAt: Date.now()});
      }
      if(fb.unsub) fb.unsub();
      fb.unsub = onSnapshot(fb.docRef, s=>{
        if(!s.exists()) return;
        const remote=(s.data().items||[]).map(normalize);
        fb.applying=true; items = mergeItems(remote, items); save(); fb.applying=false; render();
      }, e=>showError('onSnapshotå¤±æ•—', e));

      fb.connected=true; setStatus('åŒæœŸä¸­','ok');
    }).catch(e=>showError('getDocå¤±æ•—', e));
  }

  connectBtn.addEventListener('click', connect);
  disconnectBtn.addEventListener('click', disconnect);

  onAuthStateChanged(fb.auth, (u) => {
    fb.uid = u ? u.uid : null;
    if(u){
      loginBtn.classList.add('hide');
      logoutBtn.classList.remove('hide');
      userInfo.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${u.email||u.uid}`;
      setStatus('ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿');
      const saved = localStorage.getItem(FAMILY_KEY)||'';
      if(saved && !familyCodeInput.value) familyCodeInput.value = saved;
    }else{
      loginBtn.classList.remove('hide');
      logoutBtn.classList.add('hide');
      userInfo.textContent = '';
      setStatus('æœªæ¥ç¶š');
      disconnect();
    }
  });

  /* ===== CSV/å°åˆ·ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
  function sortForOutput(arr){
    return [...arr].sort((a,b)=>{
      const ra=(REGION_ORDER.indexOf(a.region)+1)||999;
      const rb=(REGION_ORDER.indexOf(b.region)+1)||999;
      if(ra!==rb) return ra-rb;
      const pa=prefRank(a.pref), pb=prefRank(b.pref);
      if(pa!==pb) return pa-pb;
      return (a.name||'').localeCompare(b.name||'','ja');
    });
  }
  function csvCell(v){ const s=(v??'').toString().replace(/"/g,'""'); return /[,"\n]/.test(s)?'"'+s+'"':s; }
  function toCSV(data){
    const header=['åœ°åŸŸ','éƒ½é“åºœçœŒ','åç§°','æ‰€æŒ','æ‰€æŒæ—¥'];
    const rows=data.map(x=>[x.region,x.pref,x.name,x.owned?1:0,x.ownedAt||''].map(csvCell).join(','));
    return ['\ufeff'+header.join(','),...rows].join('\n');
  }
  function downloadBlob(filename, text, mime='text/csv;charset=utf-8;'){
    const blob=new Blob([text],{type:mime});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=filename;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  function exportCSV(data, filename='chiikawa_all.csv'){
    const sorted=sortForOutput(data);
    const csv=toCSV(sorted);
    downloadBlob(filename, csv);
  }
  btnCSVAll.addEventListener('click', ()=>exportCSV(items,'chiikawa_all.csv'));

  function openPrintAll() {
    const data = sortForOutput(items);
    const win = window.open('about:blank', '_blank', 'noopener');
    if (!win) { alert('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚è¨±å¯ã—ã¦ãã ã•ã„ã€‚'); return; }
    const css = `
      :root{--text:#111;--border:#e5e7eb}
      body{font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Noto Sans JP,Meiryo,sans-serif;color:#111;margin:0;background:#fff}
      .wrap-n{max-width:1100px;margin:24px auto;padding:0 16px}
      h2{margin:0 0 12px;color:#0b1225}
      table.pretty{width:100%;border-collapse:collapse;border:1px solid var(--border)}
      table.pretty th,table.pretty td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
      thead th{background:#f8fafc}
      .b{display:inline-block;padding:2px 8px;border-radius:999px;font-weight:700;font-size:12px;border:1px solid #ddd}
      .b.yes{background:#ecfdf5;color:#065f46;border-color:#bbf7d0}
      .b.no{background:#fff1f2;color:#9f1239;border-color:#fecdd3}
      button{padding:8px 12px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer}
      @media print{#printBtn{display:none}}
    `;
    const build = () => {
      const doc = win.document;
      doc.title = 'ã¡ã„ã‹ã‚ ä¸€è¦§';
      const style = doc.createElement('style'); style.textContent = css; doc.head.appendChild(style);
      const wrap = doc.createElement('div'); wrap.className = 'wrap-n'; doc.body.appendChild(wrap);
      const h2 = doc.createElement('h2'); h2.textContent = 'ã¡ã„ã‹ã‚ ã”å½“åœ°ã‚­ãƒ¼ãƒ›ãƒ«ãƒ€ãƒ¼ ä¸€è¦§'; wrap.appendChild(h2);
      const table = doc.createElement('table'); table.className='pretty';
      const thead = doc.createElement('thead'); const trh = document.createElement('tr');
      ['åœ°åŸŸ','éƒ½é“åºœçœŒ','åç§°','æ‰€æŒ','æ‰€æŒæ—¥'].forEach(t=>{const th=document.createElement('th'); th.textContent=t; trh.appendChild(th);});
      thead.appendChild(trh); table.appendChild(thead);
      const tbody = document.createElement('tbody');
      if(data.length===0){
        const tr=document.createElement('tr'); const td=document.createElement('td'); td.colSpan=5; td.textContent='ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'; tr.appendChild(td); tbody.appendChild(tr);
      }else{
        data.forEach(x=>{
          const tr=document.createElement('tr');
          const td1=document.createElement('td'); td1.textContent=x.region;
          const td2=document.createElement('td'); td2.textContent=x.pref;
          const td3=document.createElement('td'); td3.textContent=x.name;
          const td4=document.createElement('td'); td4.style.textAlign='center'; const badge=document.createElement('span'); badge.className='b '+(x.owned?'yes':'no'); badge.textContent=x.owned?'æ‰€æŒ':'æœªæ‰€æŒ'; td4.appendChild(badge);
          const td5=document.createElement('td'); td5.textContent=x.ownedAt||'';
          tr.append(td1,td2,td3,td4,td5); tbody.appendChild(tr);
        });
      }
      table.appendChild(tbody); wrap.appendChild(table);
      const btnBox = document.createElement('div'); btnBox.style.textAlign='right'; btnBox.style.marginTop='10px';
      const printBtn = document.createElement('button'); printBtn.id='printBtn'; printBtn.textContent='ğŸ–¨ï¸ å°åˆ·'; printBtn.addEventListener('click', ()=>win.print());
      btnBox.appendChild(printBtn); wrap.appendChild(btnBox);
    };
    if (win.document.readyState === 'complete') build(); else win.addEventListener('load', build);
  }
  btnPrint.addEventListener('click', openPrintAll);

  /* ===== ç”»é¢æç”»ï¼ˆ2ã‚«ãƒ©ãƒ ï¼‰ ===== */
  function render(){
    app.innerHTML='';
    const frag=document.createDocumentFragment();
    const regions=[...new Set(items.map(it=>it.region))]
      .map(migrateRegion)
      .sort((a,b)=>(REGION_ORDER.indexOf(a)+1||999)-(REGION_ORDER.indexOf(b)+1||999)||a.localeCompare(b,'ja'));

    for(const r of regions){
      const rItems=items.filter(it=>migrateRegion(it.region)===r);
      const ownR=rItems.filter(x=>x.owned).length;

      const details=document.createElement('details');
      details.className='region';
      details.open=(localStorage.getItem(LS_KEY+'_open_'+r)==='1');

      const summary=document.createElement('summary');
      summary.textContent=`${r} ${ownR}/${rItems.length}`;
      details.appendChild(summary);

      const inner=document.createElement('div');
      inner.className='inner';

      // éƒ½é“åºœçœŒã§ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚° â†’ 47éƒ½é“åºœçœŒé †
      const byPref={};
      for(const it0 of rItems){
        const it=normalize(it0);
        (byPref[it.pref]||(byPref[it.pref]=[])).push(it);
      }
      const prefNames=Object.keys(byPref).sort((a,b)=>{
        const ra=prefRank(a), rb=prefRank(b);
        return (ra-rb) || a.localeCompare(b,'ja');
      });

      // 2ã‚«ãƒ©ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«
      const wrap=document.createElement('div'); wrap.className='tableWrap';
      const table=document.createElement('table'); table.className='tbl';
      const thead=document.createElement('thead'); const trh=document.createElement('tr');
      ["éƒ½é“åºœçœŒ","åç§°"].forEach(t=>{const th=document.createElement('th'); th.textContent=t; trh.appendChild(th);});
      thead.appendChild(trh); table.appendChild(thead);

      const tbody=document.createElement('tbody');
      for(const p of prefNames){
        const rows=byPref[p].sort((a,b)=>(a.name||'').localeCompare(b.name||'','ja'));
        rows.forEach((it,idx)=>{
          const tr=document.createElement('tr');

          const tdPref=document.createElement('td');
          if(idx===0){ tdPref.textContent=p; tdPref.style.whiteSpace='nowrap'; } else { tdPref.textContent=''; }
          tr.appendChild(tdPref);

          const tdName=document.createElement('td');
          const rowBox=document.createElement('div'); rowBox.className='row';

          const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=!!it.owned;
          cb.addEventListener('change',()=>{
            it.owned=cb.checked;
            if(cb.checked && !it.ownedAt) it.ownedAt=today();
            if(!cb.checked) it.ownedAt=null;
            save(); render();
          });

          const nameSpan=document.createElement('span'); nameSpan.textContent=it.name;
          const ownedBadge=document.createElement('span'); ownedBadge.className='badge'+(it.owned?' yes':''); ownedBadge.textContent=it.owned?'æ‰€æŒ':'æœªæ‰€æŒ';
          const dateSmall=document.createElement('span'); dateSmall.className='small-muted'; dateSmall.textContent = it.ownedAt ? `(${it.ownedAt})` : '';

          rowBox.append(cb, nameSpan, ownedBadge, dateSmall);
          tdName.appendChild(rowBox);
          tr.appendChild(tdName);

          tbody.appendChild(tr);
        });
      }

      table.appendChild(tbody); wrap.appendChild(table); inner.appendChild(wrap);
      details.appendChild(inner);
      details.addEventListener('toggle',()=>localStorage.setItem(LS_KEY+'_open_'+r,details.open?'1':'0'));
      frag.appendChild(details);
    }

    app.appendChild(frag);

    const ownTotal=items.filter(x=>x.owned).length;
    document.getElementById('stats').textContent =
      `${ownTotal}/${items.length} æ‰€æŒ (${items.length?Math.round(ownTotal/items.length*100):0}%)`;
  }

  // åˆæœŸæç”»ï¼ˆå®¶æ—ã‚³ãƒ¼ãƒ‰å¾©å…ƒï¼‰
  const savedFamily = localStorage.getItem(FAMILY_KEY)||'';
  if(savedFamily) familyCodeInput.value = savedFamily;
  render();
})(); // IIFE
</script>
</body>
</html>
